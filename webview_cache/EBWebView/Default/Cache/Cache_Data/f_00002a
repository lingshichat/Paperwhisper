<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>纸语 PaperWhisper</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/static/css/flatpickr.min.css">
    <script src="/static/js/flatpickr.js"></script>
    <script src="/static/js/zh.js"></script>
    <script src="/static/js/marked.min.js"></script>
    <script src="/static/js/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-wood: radial-gradient(circle at 50% 50%, #4a3b32 0%, #2d241f 100%);
            --bg-leather: #3e2723;
            --paper-color: #f7f1e3;
            --text-primary: #5d4037;
            --text-secondary: #8d6e63;
            --accent-red: #c0392b;
            --sidebar-width: 260px;
            /* Sidebar Defaults */
            --sidebar-bg: linear-gradient(to bottom, #3e2723, #281815);
            --sidebar-border: 1px solid #1a100d;
            --sidebar-texture: none;
            --sidebar-deco-color: rgba(0, 0, 0, 0.2);
            --sidebar-text: #d7ccc8;
        }

        /* Themes */
        /* 1. Vintage (时光旧物) */
        /* 1. Vintage (时光旧物) - 磨砂皮 + 圆柱光影 */
        body[data-theme='vintage'] {
            --bg-wood: #3E2723;
            --bg-leather: #5D4037;
            --paper-color: #F4ECD8;
            --text-primary: #2C3E50;
            --text-secondary: #5D4037;
            --accent-red: #8D6E63;

            /* Premium Polish */
            --sidebar-bg: linear-gradient(to right, #5d4037 0%, #4e342e 40%, #3e2723 100%);
            --sidebar-border: none;
            --sidebar-text: #efebe9;
            --sidebar-texture: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            --sidebar-deco-color: rgba(0, 0, 0, 0.3);
        }

        /* 2. Sea of Flowers (海底花海) */
        /* 2. Sea of Flowers (海底花海) - 梦幻粉色 + 深度毛玻璃 + 动态水流 */
        /* 2. Sea of Flowers (海底花海) */
        /* 2. Sea of Flowers (海底花海) - 梦幻粉色 + 深度毛玻璃 + 动态水流 */
        body[data-theme='sea_flower'] {
            /* 核心变量 */
            --bg-wood: #D4B5C6;
            --bg-leather: #F6D9E6;
            --paper-color: rgba(255, 255, 255, 0.9);
            /* 提高不透明度，增强质感 */
            --text-primary: #5E3B56;
            --text-secondary: #9C7A8E;
            --accent-red: #C590B0;

            /* Sidebar Variables */
            /* 更协调的乳白色毛玻璃，带一点粉调 */
            --sidebar-bg: rgba(255, 245, 250, 0.4);
            --sidebar-border: 1px solid rgba(255, 255, 255, 0.6);
            --sidebar-text: #6A4C62;
            /* 柔和的深紫灰 */
            --sidebar-texture: none;
            --sidebar-deco-color: rgba(255, 255, 255, 0.5);

            /* Dynamic Background: Sea of Flowers */
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='sea_grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23E0C3FC' /%3E%3Cstop offset='50%25' stop-color='%23CBB4D4' /%3E%3Cstop offset='100%25' stop-color='%238EC5FC' /%3E%3C/linearGradient%3E%3Cfilter id='blur' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeGaussianBlur stdDeviation='3'/%3E%3C/filter%3E%3Cstyle%3E .petal %7B animation: float 15s infinite ease-in-out; opacity: 0.6; %7D .bubble %7B animation: rise 20s infinite linear; opacity: 0.4; %7D @keyframes float %7B 0%25, 100%25 %7B transform: translateY(0) rotate(0deg); opacity: 0.5; %7D 50%25 %7B transform: translateY(-30px) rotate(15deg); opacity: 0.9; %7D %7D @keyframes rise %7B 0%25 %7B transform: translateY(100vh) scale(0.5); opacity: 0; %7D 50%25 %7B opacity: 0.8; %7D 100%25 %7B transform: translateY(-10vh) scale(1.2); opacity: 0; %7D %7D %3C/style%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23sea_grad)' /%3E%3C!-- Bubbles --%3E%3Ccircle cx='15%25' cy='100%25' r='10' fill='white' class='bubble' style='animation-duration: 25s; animation-delay: 0s;' filter='url(%23blur)' /%3E%3Ccircle cx='75%25' cy='100%25' r='8' fill='white' class='bubble' style='animation-duration: 18s; animation-delay: 5s;' filter='url(%23blur)' /%3E%3Ccircle cx='40%25' cy='100%25' r='5' fill='white' class='bubble' style='animation-duration: 30s; animation-delay: 10s;' filter='url(%23blur)' /%3E%3C!-- Petals --%3E%3Ccircle cx='10%25' cy='20%25' r='30' fill='%23F6D9E6' class='petal' style='animation-duration: 12s;' filter='url(%23blur)' /%3E%3Ccircle cx='85%25' cy='15%25' r='40' fill='%23FFFFFF' class='petal' style='animation-duration: 15s; animation-delay: 2s;' filter='url(%23blur)' opacity='0.3' /%3E%3Ccircle cx='50%25' cy='60%25' r='20' fill='%23E0C3FC' class='petal' style='animation-duration: 18s; animation-delay: 5s;' filter='url(%23blur)' /%3E%3Ccircle cx='80%25' cy='80%25' r='25' fill='%23F6D9E6' class='petal' style='animation-duration: 14s; animation-delay: 1s;' filter='url(%23blur)' /%3E%3C/svg%3E");
            background-attachment: fixed;
            background-size: cover;
        }

        /* [Theme Component Overrides: Sea of Flowers - Refined] */

        /* 1. Sidebar - True Glassmorphism */
        body[data-theme='sea_flower'] .sidebar {
            backdrop-filter: blur(30px) saturate(160%);
            -webkit-backdrop-filter: blur(30px) saturate(160%);
            background-color: var(--sidebar-bg);
            box-shadow: 5px 0 30px rgba(94, 59, 86, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.4);
        }

        body[data-theme='sea_flower'] .app-name-zh {
            /* 品牌色：深邃的紫檀色，不再使用透明渐变以保证清晰度 */
            color: #5E3B56;
            background: none;
            -webkit-text-fill-color: initial;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
            font-weight: 900;
            letter-spacing: 2px;
        }

        body[data-theme='sea_flower'] .app-name-en {
            color: #9C7A8E;
            font-weight: 600;
            opacity: 1;
            letter-spacing: 1px;
        }

        body[data-theme='sea_flower'] .menu-item {
            color: #5E3B56;
            margin: 0 10px;
        }

        /* Footer Hitokoto Text Coordination */
        body[data-theme='sea_flower'] #hitokoto-text,
        body[data-theme='sea_flower'] #hitokoto-author {
            color: #6A4C62 !important;
            /* Force override style attribute */
            opacity: 0.9;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        body[data-theme='sea_flower'] .menu-item:hover {
            background: rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 12px rgba(197, 144, 176, 0.2);
            color: #4A2B42;
        }

        body[data-theme='sea_flower'] .menu-item.active {
            background: linear-gradient(to right, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.6));
            color: #4A2B42;
            box-shadow: 0 4px 15px rgba(197, 144, 176, 0.25);
            border: 1px solid #fff;
        }

        body[data-theme='sea_flower'] .btn-new-diary {
            background: linear-gradient(135deg, #D4A5C6 0%, #C590B0 100%);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 20px rgba(158, 112, 137, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            color: #fff;
            text-shadow: 0 1px 2px rgba(94, 59, 86, 0.2);
        }

        body[data-theme='sea_flower'] .search-box {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: inset 0 2px 4px rgba(94, 59, 86, 0.05);
        }

        body[data-theme='sea_flower'] .search-input {
            color: #5E3B56;
        }

        body[data-theme='sea_flower'] .search-input::placeholder {
            color: rgba(94, 59, 86, 0.6);
        }

        /* 2. Cards - Levitating Glass */
        body[data-theme='sea_flower'] .card {
            background-color: var(--paper-color);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 10px 30px rgba(94, 59, 86, 0.08), inset 0 0 0 1px rgba(255, 255, 255, 0.5);
            border-radius: 16px;
        }

        body[data-theme='sea_flower'] .card:hover {
            transform: translateY(-6px) scale(1.01);
            box-shadow: 0 20px 40px rgba(197, 144, 176, 0.3), inset 0 0 0 1px rgba(255, 255, 255, 0.8);
            border-color: #E0C3FC;
        }

        /* Decorative Watermark for Cards - Fixed Size & Position */
        body[data-theme='sea_flower'] .card::after {
            content: '✿';
            position: absolute;
            bottom: -5px;
            right: 0px;
            font-size: 50px;
            /* Reduced from 100px to fix size issues */
            background: linear-gradient(135deg, #E0C3FC, #C590B0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0.15;
            filter: blur(0.5px);
            pointer-events: none;
            /* Critical: click through */
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
            z-index: 0;
        }

        body[data-theme='sea_flower'] .card:hover::after {
            opacity: 0.3;
            transform: scale(1.2) rotate(45deg);
            /* Subtle animation */
            bottom: 5px;
            right: 10px;
            filter: blur(0px);
        }

        body[data-theme='sea_flower'] .card-meta {
            border-bottom: 1px dashed rgba(197, 144, 176, 0.3);
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        body[data-theme='sea_flower'] .card-title {
            font-family: 'Noto Serif SC', serif;
            letter-spacing: 1px;
            margin-bottom: 15px;
        }

        /* 3. Editor & Reader Areas */
        body[data-theme='sea_flower'] .full-page-view {
            background: var(--bg-wood);
            /* Fallback */
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='sea_grad_edit' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23E0C3FC' /%3E%3Cstop offset='100%25' stop-color='%238EC5FC' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23sea_grad_edit)' opacity='0.3' /%3E%3C/svg%3E");
            backdrop-filter: blur(30px);
            /* Heavy blur for focus */
        }

        body[data-theme='sea_flower'] .editor-top-bar {
            background: rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 5px 20px rgba(94, 59, 86, 0.05);
        }

        body[data-theme='sea_flower'] .paper-sheet {
            background-color: #FFF;
            box-shadow: 0 20px 60px rgba(94, 59, 86, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 4px;
        }

        body[data-theme='sea_flower'] .paper-sheet::before {
            background: linear-gradient(90deg, #E0C3FC, #C590B0);
        }

        body[data-theme='sea_flower'] .ribbon {
            background: #C590B0;
            box-shadow: 0 5px 15px rgba(197, 144, 176, 0.6);
        }

        body[data-theme='sea_flower'] .ribbon::after {
            border-left-color: #a87999;
            border-right-color: #a87999;
        }

        body[data-theme='sea_flower'] textarea.edit-content,
        body[data-theme='sea_flower'] .read-body {
            background-image: linear-gradient(transparent 31px, rgba(197, 144, 176, 0.15) 32px);
        }

        /* 3. Midnight (午夜星尘) - 沉浸式动态星空 + 暗色拟物 */
        body[data-theme='midnight'] {
            /* 核心变量 */
            --bg-wood: #050510;
            --bg-leather: #0a0a14;
            --paper-color: #161b22;
            /* 深色信纸 */
            --text-primary: #e6edf3;
            /* 柔和白 */
            --text-secondary: #8b949e;
            /* 银灰 */
            --accent-red: #7986cb;
            /* Revised: 沉稳的靛蓝色 (Muted Indigo) */

            /* Sidebar Variables */
            --sidebar-bg: rgba(13, 17, 23, 0.7);
            /* 增加透明度 */
            --sidebar-border: none;
            --sidebar-text: #c9d1d9;
            --sidebar-texture: none;
            /* 去除旧纹理，依靠背景透视 */
            --sidebar-deco-color: rgba(121, 134, 203, 0.2);

            /* Dynamic Starry Background (All Stars) */
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3CradialGradient id='sky' cx='50%25' cy='100%25' r='120%25' fx='50%25' fy='100%25'%3E%3Cstop offset='0%25' stop-color='%231a237e' /%3E%3Cstop offset='50%25' stop-color='%23050510' /%3E%3Cstop offset='100%25' stop-color='%23000000' /%3E%3C/radialGradient%3E%3Csymbol id='star' viewBox='0 0 24 24'%3E%3Cpath d='M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z' fill='white' /%3E%3C/symbol%3E%3Cfilter id='glow'%3E%3CfeGaussianBlur stdDeviation='1.5' result='coloredBlur'/%3E%3CfeMerge%3E%3CfeMergeNode in='coloredBlur'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23sky)' /%3E%3C!-- Hanging Strings --%3E%3Cg stroke='rgba(255,255,255,0.1)' stroke-width='1'%3E%3Cline x1='15%25' y1='0' x2='15%25' y2='30%25' /%3E%3Cline x1='35%25' y1='0' x2='35%25' y2='50%25' /%3E%3Cline x1='60%25' y1='0' x2='60%25' y2='25%25' /%3E%3Cline x1='80%25' y1='0' x2='80%25' y2='40%25' /%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='15%25' /%3E%3C/g%3E%3C!-- Hanging Stars --%3E%3Cg filter='url(%23glow)'%3E%3Cuse href='%23star' x='13.5%25' y='28%25' width='3%25' height='3%25' opacity='0.9'%3E%3Canimate attributeName='opacity' values='0.4;1;0.4' dur='4s' repeatCount='indefinite' /%3E%3CanimateTransform attributeName='transform' type='rotate' from='0 15%25 30%25' to='5 15%25 30%25' dur='5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='33.5%25' y='48%25' width='3.5%25' height='3.5%25' opacity='1'%3E%3Canimate attributeName='opacity' values='0.5;1;0.5' dur='3s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='58.8%25' y='23%25' width='2.5%25' height='2.5%25' opacity='0.8'%3E%3Canimate attributeName='opacity' values='0.3;0.9;0.3' dur='5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='78.5%25' y='38%25' width='3%25' height='3%25' opacity='0.9'%3E%3Canimate attributeName='opacity' values='0.2;1;0.2' dur='3.5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='49%25' y='13%25' width='2%25' height='2%25' opacity='0.7'%3E%3Canimate attributeName='opacity' values='0.4;0.8;0.4' dur='4.5s' repeatCount='indefinite' /%3E%3C/use%3E%3C/g%3E%3C!-- Background Tiny Stars (All Stars Now) --%3E%3Cg filter='url(%23glow)'%3E%3Cuse href='%23star' x='10%25' y='60%25' width='1.5%25' height='1.5%25'%3E%3Canimate attributeName='opacity' values='0;1;0' dur='3s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='90%25' y='80%25' width='2%25' height='2%25'%3E%3Canimate attributeName='opacity' values='0;0.8;0' dur='4s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='25%25' y='90%25' width='1.2%25' height='1.2%25'%3E%3Canimate attributeName='opacity' values='0;0.6;0' dur='5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='70%25' y='10%25' width='1.5%25' height='1.5%25'%3E%3Canimate attributeName='opacity' values='0;0.9;0' dur='2.5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='5%25' y='40%25' width='1.8%25' height='1.8%25'%3E%3Canimate attributeName='opacity' values='0;0.7;0' dur='3.5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='85%25' y='5%25' width='1.5%25' height='1.5%25'%3E%3Canimate attributeName='opacity' values='0;0.8;0' dur='4.5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='40%25' y='95%25' width='1.2%25' height='1.2%25'%3E%3Canimate attributeName='opacity' values='0;0.5;0' dur='6s' repeatCount='indefinite' /%3E%3C/use%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            /* 固定背景 */
        }

        /* Midnight Specific Component Overrides */

        /* 1. Sidebar - Glassmorphism & Neon */
        body[data-theme='midnight'] .sidebar {
            backdrop-filter: blur(15px);
            background: var(--sidebar-bg);
            /* Use rgba */
            box-shadow: 1px 0 20px rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            /* Subtle border for definition */
        }

        body[data-theme='midnight'] .btn-new-diary {
            background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(132, 70, 240, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-weight: 600;
            letter-spacing: 1px;
        }

        body[data-theme='midnight'] .btn-new-diary:hover {
            box-shadow: 0 6px 20px rgba(132, 70, 240, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            filter: brightness(1.1);
        }

        body[data-theme='midnight'] .search-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        body[data-theme='midnight'] .search-input::placeholder {
            color: rgba(201, 209, 217, 0.4);
        }

        body[data-theme='midnight'] .menu-item.active {
            background-color: rgba(121, 134, 203, 0.25);
            /* Muted Indigo Tint */
            border-left: none;
            /* Remove border to match default logic */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            color: #fff;
            font-weight: bold;
        }

        /* 2. Cards - Floating Dark Matter */
        body[data-theme='midnight'] .card {
            background-image: none;
            /* Remove parchment texture */
            background-color: var(--paper-color);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
        }

        body[data-theme='midnight'] .card-meta {
            color: #6e7681;
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        /* [Decor] Card Star Shine */
        /* [Decor] Card Star Shine */
        body[data-theme='midnight'] .card {
            position: relative;
            /* Ensure absolute child aligns */
            /* Gradient transparency: Top-Left (Less Transparent) -> Bottom-Right (More Transparent) */
            background: linear-gradient(135deg, rgba(30, 37, 46, 0.85) 0%, rgba(22, 27, 34, 0.45) 100%);
            backdrop-filter: blur(10px);
            /* Glass effect */
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(121, 134, 203, 0.2);
            transition: all 0.3s ease;
        }

        body[data-theme='midnight'] .card::after {
            content: '✦';
            position: absolute;
            bottom: 15px;
            /* Moved to bottom */
            right: 20px;
            /* Moved to right */
            top: auto;
            /* Reset top */
            font-size: 24px;
            /* Slightly larger */
            color: rgba(121, 134, 203, 0.3);
            /* Idle state: Dim Muted Indigo */
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: none;
            pointer-events: none;
            transform: scale(1) rotate(0deg);
        }

        body[data-theme='midnight'] .card:hover::after {
            color: #fff;
            text-shadow: 0 0 10px #7986cb, 0 0 20px #fff;
            /* Bright Glow */
            transform: scale(1.3) rotate(180deg);
            /* Rotate animation */
            opacity: 1;
        }

        body[data-theme='midnight'] .card:hover {
            border-color: rgba(121, 134, 203, 0.4);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6),
                inset 0 0 20px rgba(0, 0, 0, 0.2),
                0 0 30px rgba(121, 134, 203, 0.1);
            /* Subtle aura */
            transform: translateY(-5px);
            z-index: 5;
        }

        /* [Fix] Card Title Visibility */
        body[data-theme='midnight'] .card-title {
            color: #e6edf3;
        }

        /* 3. Editor Paper - Dark Sheet */
        body[data-theme='midnight'] .paper-sheet {
            background-image: none;
            background-color: var(--paper-color);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        body[data-theme='midnight'] .paper-sheet::before {
            background-color: #5c6bc0;
            /* Revised: Muted Blue Header */
            box-shadow: 0 0 10px rgba(92, 107, 192, 0.5);
        }

        body[data-theme='midnight'] .ribbon {
            background-color: #3949ab;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        body[data-theme='midnight'] .ribbon::after {
            border-left-color: #3949ab;
            border-right-color: #3949ab;
        }

        body[data-theme='midnight'] .edit-title,
        body[data-theme='midnight'] .read-title {
            color: #e6edf3 !important;
            /* Force override */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        body[data-theme='midnight'] input.edit-title::placeholder {
            color: rgba(139, 148, 158, 0.5);
        }

        body[data-theme='midnight'] .divider-line {
            background-color: rgba(255, 255, 255, 0.1);
        }

        body[data-theme='midnight'] textarea.edit-content,
        body[data-theme='midnight'] .read-body {
            color: var(--text-primary);
            /* Adjust lines for dark mode */
            background-image: linear-gradient(transparent 31px, rgba(255, 255, 255, 0.05) 32px);
        }

        body[data-theme='midnight'] .btn-done {
            background: linear-gradient(to bottom, #21262d, #161b22);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #c9d1d9;
        }

        body[data-theme='midnight'] .btn-done:hover {
            border-color: #8b949e;
            color: #fff;
        }

        /* [Fix] Editor Top Bar */
        body[data-theme='midnight'] .editor-top-bar {
            background-color: rgba(5, 5, 16, 0.85);
            /* Darker Match */
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
        }

        /* [Fix] Selector Colors */
        body[data-theme='midnight'] .select-clean {
            color: #c9d1d9;
            background-color: transparent;
            /* Or darker if needed */
            color-scheme: dark;
            /* Force browser to use dark dropdown */
        }

        body[data-theme='midnight'] .select-clean option {
            background-color: #161b22;
            color: #c9d1d9;
        }

        /* [Fix] Flatpickr Calendar Adaptation */
        body[data-theme='midnight'] .flatpickr-calendar {
            background: rgba(22, 27, 34, 0.95) !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
        }

        body[data-theme='midnight'] .flatpickr-months .flatpickr-month,
        body[data-theme='midnight'] .flatpickr-weekdays {
            background: transparent !important;
            color: #e6edf3 !important;
        }

        body[data-theme='midnight'] .flatpickr-monthDropdown-months {
            background: #161b22 !important;
            color: #e6edf3 !important;
        }

        body[data-theme='midnight'] .flatpickr-monthDropdown-months:hover {
            background: #21262d !important;
        }

        body[data-theme='midnight'] .flatpickr-current-month input.cur-year {
            color: #e6edf3 !important;
        }

        body[data-theme='midnight'] .flatpickr-day {
            color: #c9d1d9 !important;
        }

        body[data-theme='midnight'] .flatpickr-day:hover,
        body[data-theme='midnight'] .flatpickr-day.prevMonthDay:hover,
        body[data-theme='midnight'] .flatpickr-day.nextMonthDay:hover,
        body[data-theme='midnight'] .flatpickr-day:focus {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: transparent !important;
        }

        body[data-theme='midnight'] .flatpickr-day.selected {
            background: var(--accent-red) !important;
            border-color: var(--accent-red) !important;
            color: #fff !important;
            box-shadow: 0 0 10px rgba(121, 134, 203, 0.4);
        }

        body[data-theme='midnight'] .flatpickr-prev-month,
        body[data-theme='midnight'] .flatpickr-next-month {
            fill: #e6edf3 !important;
            color: #e6edf3 !important;
        }

        /* Dropdown arrow fix */
        body[data-theme='midnight'] .flatpickr-current-month .numInputWrapper span.arrowUp:after {
            border-bottom-color: #e6edf3 !important;
        }

        body[data-theme='midnight'] .flatpickr-current-month .numInputWrapper span.arrowDown:after {
            border-top-color: #e6edf3 !important;
        }

        body {
            font-family: 'Noto Serif SC', "Songti SC", serif;
            background: var(--bg-wood);
            background-size: cover;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: var(--text-primary);
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* 侧边栏 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: var(--sidebar-border);
            box-shadow: inset -2px 0 10px rgba(0, 0, 0, 0.2);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            z-index: 10;
            position: relative;
            overflow: hidden;
            /* For texture containment */
            transition: all 0.3s ease;
        }

        /* Sidebar Texture/Decoration Layer */
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--sidebar-texture);
            opacity: 0.8;
            pointer-events: none;
            z-index: 0;
        }

        /* Special Decor for Zen (Binding Line) */
        body[data-theme='zen'] .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 15px;
            width: 2px;
            height: 100%;
            border-right: 1px dashed #cfd8dc;
            /* Stitching line */
            z-index: 1;
        }

        /* Special Decor for Midnight (Glow Border) */
        body[data-theme='midnight'] .sidebar {
            box-shadow: 1px 0 15px rgba(0, 0, 0, 0.5), inset -1px 0 0 var(--sidebar-deco-color);
        }

        /* Ensure content is above texture */
        .sidebar-header,
        .sidebar-tools,
        .sidebar-menu {
            position: relative;
            z-index: 2;
        }

        /* LOGO: 纯文字，精致排版 */
        .sidebar-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 35px;
            padding-left: 5px;
        }

        .app-name-zh {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            color: #eefeeb;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .app-name-en {
            font-size: 12px;
            font-weight: normal;
            color: var(--sidebar-text);
            letter-spacing: 0.5px;
            opacity: 0.8;
            font-family: 'Noto Serif SC', serif;
        }

        .sidebar-tools {
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 按钮：写一篇 */
        .btn-new-diary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: var(--accent-red);
            color: #fff;
            font-weight: bold;
            text-decoration: none;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 2;
        }

        .btn-new-diary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            filter: brightness(1.1);
        }

        .btn-new-diary:active {
            transform: translateY(0);
        }

        /* 搜索框：极简无图标 */
        .search-box {
            display: flex;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 6px;
            padding: 2px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2;
        }

        .search-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--sidebar-text);
            padding: 10px 12px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            text-align: left;
        }

        .search-input::placeholder {
            color: var(--sidebar-text);
            opacity: 0.5;
            font-size: 13px;
        }

        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 15px;
            color: var(--sidebar-text);
            opacity: 0.8;
            cursor: pointer;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            opacity: 1;
        }

        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            opacity: 1;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .menu-icon {
            font-size: 18px;
            opacity: 0.8;
        }

        /* 主区域 */
        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .list-view {
            flex-grow: 1;
            overflow-y: auto;
            padding: 40px;
            box-shadow: inset 0 0 150px rgba(0, 0, 0, 0.6);
        }

        .waterfall {
            column-count: 3;
            column-gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        @media (max-width: 1100px) {
            .waterfall {
                column-count: 2;
            }
        }

        @media (max-width: 700px) {
            .waterfall {
                column-count: 1;
            }
        }

        /* 卡片 */
        .card {
            background-color: var(--paper-color);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            break-inside: avoid;
            margin-bottom: 30px;
            padding: 25px;
            position: relative;
            display: block;
            color: var(--text-primary);
            transition: transform 0.2s;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card-meta {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed rgba(93, 64, 55, 0.15);
            padding-bottom: 5px;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
            line-height: 1.4;
            padding-top: 5px;
        }

        .card-preview {
            font-size: 15px;
            line-height: 1.8;
            opacity: 0.9;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            line-clamp: 5;
            overflow: hidden;
        }

        /* 空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
            opacity: 0.6;
            animation: fadeIn 1s ease;
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
            filter: grayscale(100%) opacity(0.5);
        }

        .empty-text {
            font-size: 18px;
            color: var(--text-secondary);
            letter-spacing: 2px;
            font-style: italic;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 0.6;
                transform: translateY(0);
            }
        }

        /* 视图容器 */
        .full-page-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-wood);
            display: flex;
            flex-direction: column;
            z-index: 20;
        }

        .editor-top-bar {
            height: 60px;
            background-color: rgba(40, 24, 21, 0.75);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 30;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            font-size: 15px;
            color: #d7ccc8;
            transition: color 0.2s;
            cursor: pointer;
            opacity: 0.9;
        }

        .back-link:hover {
            opacity: 1;
            color: #fff;
        }

        .btn-done {
            background: linear-gradient(to bottom, #fcfcfc, #e0e0e0);
            border: 1px solid #bdc3c7;
            color: var(--accent-red);
            font-weight: bold;
            padding: 6px 20px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.1s;
        }

        .btn-done:hover {
            background: #fff;
            transform: translateY(-1px);
        }

        .btn-done:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* 纸张 */
        .paper-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            overflow-y: auto;
        }

        .paper-sheet {
            width: 700px;
            min-height: 85vh;
            background-color: var(--paper-color);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border-radius: 2px;
            padding: 60px 80px;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 50px;
        }

        .paper-sheet::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background-color: var(--accent-red);
            opacity: 0.8;
            border-radius: 2px 2px 0 0;
        }

        .ribbon {
            position: absolute;
            top: -10px;
            right: 40px;
            width: 40px;
            height: 80px;
            background-color: var(--accent-red);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
            z-index: 50;
        }

        .ribbon::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-left: 20px solid var(--accent-red);
            border-right: 20px solid var(--accent-red);
            border-bottom: 20px solid transparent;
        }

        .ribbon-stitch {
            position: absolute;
            top: 0;
            left: 5px;
            right: 5px;
            bottom: 15px;
            border-left: 1px dashed rgba(255, 255, 255, 0.4);
            border-right: 1px dashed rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }

        .edit-header {
            margin-bottom: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        input.edit-title {
            font-family: inherit;
            font-size: 36px;
            font-weight: bold;
            text-align: left;
            color: #2c241b;
            width: 100%;
            border: none;
            background: transparent;
            outline: none;
            padding: 0;
        }

        input.edit-title::placeholder {
            color: rgba(93, 64, 55, 0.3);
        }

        .meta-row {
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .meta-label {
            font-size: 10px;
            font-weight: bold;
            color: #a1887f;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-family: sans-serif;
        }

        .divider-line {
            width: 100%;
            height: 1px;
            background-color: rgba(93, 64, 55, 0.15);
            margin-bottom: 30px;
        }

        textarea.edit-content {
            width: 100%;
            min-height: 500px;
            font-family: inherit;
            font-size: 18px;
            line-height: 32px;
            color: #3e332a;
            border: none;
            background: transparent;
            outline: none;
            resize: none;
            overflow: hidden;
            background-image: linear-gradient(transparent 31px, rgba(93, 64, 55, 0.12) 32px);
            background-size: 100% 32px;
            background-attachment: local;
            background-position-y: -1px;
            padding-top: 0;
        }

        .read-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .read-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c241b;
        }

        .read-meta {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
        }

        .meta-separator {
            opacity: 0.5;
        }

        .decorative-line {
            width: 60px;
            height: 4px;
            background-color: var(--accent-red);
            margin: 25px auto 0;
            opacity: 0.6;
            border-radius: 2px;
        }

        .read-body {
            font-size: 18px;
            line-height: 32px;
            color: #3e332a;
            flex-grow: 1;
            white-space: pre-wrap;
            background-image: linear-gradient(transparent 31px, rgba(93, 64, 55, 0.12) 32px);
            background-size: 100% 32px;
            background-position-y: -1px;
            padding-top: 0;
        }

        /* Markdown Styles - Strict Vertical Rhythm */
        .read-body p {
            margin-top: 0;
            margin-bottom: 32px;
            line-height: 32px;
        }

        .read-body ul,
        .read-body ol,
        .read-body blockquote {
            margin-top: 0;
            margin-bottom: 32px;
            line-height: 32px;
        }

        .read-body h1,
        .read-body h2,
        .read-body h3,
        .read-body h4 {
            margin-top: 32px;
            margin-bottom: 32px;
            font-weight: bold;
            line-height: 32px;
        }

        .read-body blockquote {
            border-left: 5px solid var(--accent-red);
            padding-left: 15px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .read-body img {
            max-width: 100%;
            border-radius: 4px;
            /* Soft edges */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin: 32px 0;
            display: block;
        }

        .read-body ul,
        .read-body ol {
            padding-left: 2em;
        }

        .read-body pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 16px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 32px;
        }

        .read-body code {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .read-footer {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .created-with span {
            font-family: 'Noto Serif SC', serif;
            font-weight: bold;
            color: var(--text-primary);
            font-size: 14px;
            letter-spacing: 1px;
        }

        /* 字体修复 */

        .action-btn-group {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            font-size: 18px;
            cursor: pointer;
            transition: color 0.2s;
            opacity: 0.8;
            background: none;
            border: none;
            color: #d7ccc8;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .icon-btn:hover {
            color: #fff;
            opacity: 1;
        }

        .icon-btn.delete:hover {
            color: #ff6b6b;
        }

        .date-input-clean {
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            background: transparent;
            border: none;
            cursor: pointer;
            width: 110px;
            outline: none;
            text-align: left;
        }

        .select-clean {
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            background: transparent;
            border: none;
            cursor: pointer;
            outline: none;
            appearance: none;
            padding-right: 15px;
        }

        /* Flatpickr */
        .flatpickr-calendar {
            background: var(--paper-color) !important;
            border: 1px solid #d7ccc8 !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4) !important;
            font-family: 'Noto Serif SC', serif !important;
            border-radius: 4px !important;
            width: auto !important;
            padding: 5px !important;
        }

        .flatpickr-months {
            background: var(--bg-leather) !important;
            color: #fff !important;
            padding-top: 5px;
            border-radius: 4px 4px 0 0;
        }

        .flatpickr-months .flatpickr-month {
            color: #d7ccc8 !important;
            fill: #d7ccc8 !important;
        }

        .flatpickr-weekdays {
            background: var(--bg-leather) !important;
        }

        span.flatpickr-weekday {
            color: #a1887f !important;
            font-weight: bold !important;
        }

        .flatpickr-day {
            color: var(--text-primary) !important;
            font-weight: bold;
            border-radius: 4px !important;
        }

        .flatpickr-day:hover {
            background: #e0d8c0 !important;
            border-color: transparent !important;
        }

        .flatpickr-day.selected {
            background: var(--accent-red) !important;
            border-color: var(--accent-red) !important;
            color: #fff !important;
        }

        .flatpickr-day.today {
            border-color: transparent !important;
            border-bottom: 2px solid var(--accent-red) !important;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* SVG 图标 */
        .sys-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: text-bottom;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .edit-icon-wrapper .sys-icon {
            width: 24px;
            height: 24px;
        }

        /* --- Theme Gallery Modal CSS --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .theme-gallery {
            background: var(--paper-color);
            padding: 40px;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .gallery-title {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .theme-card {
            background: rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .theme-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.08);
        }

        .theme-card.active {
            border-color: var(--accent-red);
            background: rgba(var(--accent-red-rgb), 0.1);
            /* 需要确切的颜色处理，这里简化 */
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05);
        }

        .theme-preview-box {
            width: 100%;
            height: 80px;
            border-radius: 4px;
            margin-bottom: 5px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* Preview Patterns */
        .preview-default {
            background: radial-gradient(circle at 50% 50%, #4a3b32 0%, #2d241f 100%);
        }

        .preview-vintage {
            background: #3E2723;
        }

        .preview-sea_flower {
            background: linear-gradient(135deg, #F6D9E6, #DBBAD0);
        }

        .preview-midnight {
            background: #161B22;
        }

        .theme-name {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 16px;
        }

        .theme-desc {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .close-gallery-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-gallery-btn:hover {
            color: var(--accent-red);
        }
    </style>
</head>

<body data-theme="default">
    <div class="sidebar">
        <div class="sidebar-header">
            <span class="app-name-zh">纸语</span>
            <span class="app-name-en">PaperWhisper</span>
        </div>

        <div class="sidebar-tools">
            <a href="/?view=edit&new=true" class="btn-new-diary">
                <span>✎</span> 写一篇
            </a>

            <form action="/" method="GET" class="search-box">
                <input type="text" name="q" class="search-input" placeholder="搜索记忆碎片..."
                    value="" autocomplete="off">
            </form>
        </div>

        <nav class="sidebar-menu">
            <a href="/" class="menu-item ">
                <span class="menu-icon">≡</span> 全部便签
            </a>
            <a href="#" class="menu-item" onclick="openSettings()">
                <span class="menu-icon">⚙</span> 设置风格
            </a>

            <div id="hitokoto-container"
                style="margin-top: auto; font-size: 12px; color: rgba(255,255,255,0.5); padding: 15px; font-style: italic; border-top: 1px solid rgba(255,255,255,0.05);">
                <span id="hitokoto-text">正在获取一言...</span>
                <br>
                <span id="hitokoto-author" style="float: right; opacity: 0.7;"></span>
            </div>
        </nav>
    </div>

    <!-- Settings Modal -->
    <!-- Theme Gallery Modal -->
    <div id="settings-modal" class="modal-overlay" onclick="if(event.target === this) closeSettings()">
        <div class="theme-gallery">
            <button class="close-gallery-btn" onclick="closeSettings()">×</button>
            <h3 class="gallery-title">风格画廊</h3>

            <div class="theme-grid">
                <!-- 1. Default -->
                <div class="theme-card" onclick="setTheme('default')" id="card-default">
                    <div class="theme-preview-box preview-default"></div>
                    <div class="theme-name">经典木纹</div>
                    <div class="theme-desc">深色圆木，温润如玉</div>
                </div>

                <!-- 2. Vintage -->
                <div class="theme-card" onclick="setTheme('vintage')" id="card-vintage">
                    <div class="theme-preview-box preview-vintage"></div>
                    <div class="theme-name">时光旧物</div>
                    <div class="theme-desc">泛黄羊皮，怀旧岁月</div>
                </div>

                <!-- 3. Sea of Flowers -->
                <div class="theme-card" onclick="setTheme('sea_flower')" id="card-sea_flower">
                    <div class="theme-preview-box preview-sea_flower"></div>
                    <div class="theme-name">海底花海</div>
                    <div class="theme-desc">粉色渐变色<br>适用于清新手帐制作</div>
                </div>

                <!-- 4. Midnight -->
                <div class="theme-card" onclick="setTheme('midnight')" id="card-midnight">
                    <div class="theme-preview-box preview-midnight"></div>
                    <div class="theme-name">午夜星尘</div>
                    <div class="theme-desc">静谧深夜，独处时光</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">

        

        
        <div class="full-page-view">
            <div class="editor-top-bar">
                <a href="/" class="back-link">← 返回列表</a>
                <div class="action-btn-group">
                    <button type="button" class="icon-btn" onclick="exportToImage()" title="导出图片">📷 导出</button>
                    <a href="/?view=edit&file=2025-12-30_6b03eb6c.txt" class="icon-btn" title="编辑">✎ 编辑</a>
                    <a href="/delete?file=2025-12-30_6b03eb6c.txt" class="icon-btn delete"
                        onclick="return confirm('确认撕毁这张便签吗？');" title="删除">🗑️ 删除</a>
                </div>
            </div>

            <div class="paper-container">
                <div class="paper-sheet">
                    <div class="ribbon">
                        <div class="ribbon-stitch"></div>
                    </div>
                    <div class="read-header">
                        <h1 class="read-title">无题</h1>
                        <div class="read-meta">
                            <span>2025-12-30</span>
                            <span class="meta-separator">·</span>
                            <span class="js-render-icon" data-type="weather" data-value="sunny"></span>
                            <span>晴</span>
                            <span class="meta-separator">·</span>
                            <span class="js-render-icon" data-type="mood" data-value="calm"></span>
                            <span>平静</span>
                        </div>
                        <div class="decorative-line"></div>
                    </div>
                    <div class="read-body">2</div>
                    <div class="read-footer">
                        <div class="created-with">CREATED WITH<br><span>纸语 PaperWhisper</span></div>
                        <div style="opacity: 0.5;">🔗</div>
                    </div>
                </div>
            </div>
        </div>
        

        

    </div>

    <script>
        const iconPaths = {
            weather: {
                sunny: '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>',
                cloudy: '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>',
                rainy: '<line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="9.6" y2="9.6"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path>',
                snowy: '<line x1="8" y1="8" x2="16" y2="16"></line><line x1="16" y1="8" x2="8" y2="16"></line><line x1="12" y1="3" x2="12" y2="21"></line><line x1="3" y1="12" x2="21" y2="12"></line>',
                windy: '<path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path>'
            },
            mood: {
                calm: '<circle cx="12" cy="12" r="10"></circle><line x1="8" y1="15" x2="16" y2="15"></line><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>',
                happy: '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>',
                excited: '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line><line x1="12" y1="2" x2="12" y2="4"></line><line x1="4.93" y1="4.93" x2="6.34" y2="6.34"></line><line x1="19.07" y1="4.93" x2="17.66" y2="6.34"></line>',
                sad: '<circle cx="12" cy="12" r="10"></circle><path d="M16 16s-1.5-2-4-2-4 2-4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>',
                tired: '<circle cx="12" cy="12" r="10"></circle><path d="M9 12h6"></path><path d="M15 9h.01"></path><path d="M9 9h.01"></path>'
            }
        };

        function getIconHtml(type, value) {
            const path = iconPaths[type][value] || iconPaths[type]['sunny'];
            return `<svg class="sys-icon" viewBox="0 0 24 24">${path}</svg>`;
        }

        function updateIcon(type) {
            const select = document.getElementById(type + '-select');
            const iconContainer = document.getElementById(type + '-icon-container');
            if (select && iconContainer) {
                iconContainer.innerHTML = getIconHtml(type, select.value);
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        window.onload = function () {
            var textarea = document.getElementById("diaryArea");
            if (textarea) {
                autoResize(textarea);
                // Don't focus immediately to avoid jumping if previewing
                if (document.getElementById('markdown-toggle') && document.getElementById('markdown-toggle').checked) {
                    updateMarkdownUI(); // Initialize UI state
                }

                updateIcon('weather');
                updateIcon('mood');
                flatpickr(".date-input-clean", { locale: "zh", dateFormat: "Y-m-d", altInput: true, altFormat: "Y/m/d", allowInput: false, static: true });
            }

            // Render Markdown in Read Mode if enabled
            const readBody = document.querySelector('.read-body');
            // Use rendered values strictly as strings or booleans
            const isReadMode = "True" === "True";
            const isMarkdown = "false".trim().toLowerCase() === "true";

            if (isReadMode && isMarkdown && readBody) {
                try {
                    if (typeof marked !== 'undefined') {
                        // Support both new (marked.parse) and old (marked) versions
                        const renderer = marked.parse || marked;
                        readBody.innerHTML = renderer(readBody.innerText);
                        readBody.style.whiteSpace = 'normal';
                    } else {
                        console.error('Marked.js missing');
                        alert('Markdown 渲染组件加载失败，请刷新重试');
                    }
                } catch (e) {
                    console.error('Markdown render error:', e);
                }
            }

            const iconPlaceholders = document.querySelectorAll('.js-render-icon');
            iconPlaceholders.forEach(el => {
                const type = el.getAttribute('data-type');
                const value = el.getAttribute('data-value');
                el.innerHTML = getIconHtml(type, value);
            });
        }

        function updateMarkdownUI() {
            const isChecked = document.getElementById('markdown-toggle').checked;
            const btn = document.getElementById('markdown-toggle-btn');
            const statusText = document.getElementById('markdown-status-text');

            // 1. Update Hidden Input
            document.getElementById('is_markdown_input').value = isChecked ? 'true' : 'false';

            // 2. Update UI Button Style
            if (isChecked) {
                btn.style.color = 'var(--accent-red)';
                btn.style.fontWeight = 'bold';
                statusText.innerText = 'Markdown';
            } else {
                btn.style.color = 'var(--text-secondary)';
                btn.style.fontWeight = 'normal';
                statusText.innerText = 'Markdown';
            }

            // 3. Toggle Preview Button Visibility
            document.getElementById('preview-btn').style.display = isChecked ? 'flex' : 'none';

            // 4. Reset View if Disabled
            if (!isChecked) {
                document.getElementById('diaryArea').style.display = 'block';
                document.getElementById('previewArea').style.display = 'none';
                document.getElementById('preview-btn').innerText = '👁️ 预览';
            }
        }

        function toggleMarkdownMode() {
            const checkbox = document.getElementById('markdown-toggle');
            checkbox.checked = !checkbox.checked; // Toggle State
            updateMarkdownUI(); // Update UI
        }

        function togglePreview() {
            const textarea = document.getElementById('diaryArea');
            const preview = document.getElementById('previewArea');
            const btn = document.getElementById('preview-btn');

            if (textarea.style.display !== 'none') {
                // Switch to Preview
                textarea.style.display = 'none';
                preview.style.display = 'block';
                preview.innerHTML = marked.parse(textarea.value);
                preview.style.whiteSpace = 'normal'; // Fix layout for MD
                // Keep lines in preview
                // preview.style.backgroundImage = 'none';
                btn.innerText = '✏️ 编辑';
            } else {
                // Switch to Edit
                textarea.style.display = 'block';
                preview.style.display = 'none';
                btn.innerText = '👁️ 预览';
                autoResize(textarea);
            }
        }

        // --- New Features Logic ---

        // 1. Safety: Unsaved Changes
        let isDirty = false;
        const diaryArea = document.getElementById('diaryArea');
        if (diaryArea) {
            diaryArea.addEventListener('input', () => { isDirty = true; });
        }

        // Intercept links
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', function (e) {
                if (isDirty && !confirm('您有未保存的修改，确定要离开吗？')) {
                    e.preventDefault();
                }
            });
        });
        // Before unload
        window.onbeforeunload = function () {
            if (isDirty) return "您有未保存的修改，确定要离开吗？";
        };

        // 2. Hitokoto
        fetch('https://v1.hitokoto.cn')
            .then(response => response.json())
            .then(data => {
                const hitokoto = document.getElementById('hitokoto-text');
                const author = document.getElementById('hitokoto-author');
                if (hitokoto && author) {
                    hitokoto.innerText = data.hitokoto;
                    author.innerText = `—— ${data.from}`;
                }
            })
            .catch(console.error);

        // 3. Export Image
        function exportToImage() {
            if (typeof html2canvas === 'undefined') {
                alert('错误：导出组件未加载 (html2canvas is undefined)');
                return;
            }

            const paper = document.querySelector('.paper-sheet');
            if (!paper) {
                alert('错误：找不到信纸元素');
                return;
            }

            // Temporary style adjustments for better screenshot
            const ribbon = paper.querySelector('.ribbon');
            if (ribbon) ribbon.style.display = 'none';

            // Show loading state
            const btn = document.querySelector('.icon-btn[title="导出图片"]');
            const originalText = btn ? btn.innerText : '📷 导出';
            if (btn) btn.innerText = '📷 正在生成...';

            html2canvas(paper, {
                backgroundColor: null, // Transparent bg if possible
                scale: 2, // High Resolution
                useCORS: true, // Try to handle cross-origin images
                logging: true // Enable logging for debug
            }).then(canvas => {
                if (ribbon) ribbon.style.display = 'block';
                if (btn) btn.innerText = originalText;

                // Send to backend
                const imageData = canvas.toDataURL("image/png");
                fetch('/save_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            prompt('✅ 导出成功！文件已保存至：\n(按 Ctrl+C 复制路径)', data.path);
                        } else {
                            alert('❌ 保存失败: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('❌ 请求失败: ' + error);
                    });

            }).catch(err => {
                if (ribbon) ribbon.style.display = 'block';
                if (btn) btn.innerText = originalText;
                alert('导出失败: ' + err);
                console.error(err);
            });
        }

        // 4. Settings & Theme Logic
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'flex';

            // Highlight current theme
            const currentTheme = localStorage.getItem('theme') || 'default';
            updateActiveCard(currentTheme);
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function updateActiveCard(themeName) {
            // Remove active class from all
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            // Add to current
            const card = document.getElementById('card-' + themeName);
            if (card) card.classList.add('active');
        }

        function setTheme(themeName) {
            // 1. Immediate UI Update
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('theme', themeName); // Backup
            updateActiveCard(themeName);

            // 2. Server Sync
            fetch('/api/setting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ theme: themeName })
            }).catch(err => console.error('Failed to sync theme:', err));
        }

        // Initialize Theme IIFE moved to top of body to prevent FOUC

    </script>

</body>

</html>