<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>纸语 PaperWhisper</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/flatpickr.min.css') }}">
    <script src="{{ url_for('static', filename='js/flatpickr.js') }}"></script>
    <script src="{{ url_for('static', filename='js/zh.js') }}"></script>
    <script src="{{ url_for('static', filename='js/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/html2canvas.min.js') }}"></script>

    <style>
        :root {
            --bg-wood: radial-gradient(circle at 50% 50%, #4a3b32 0%, #2d241f 100%);
            --bg-leather: #3e2723;
            --paper-color: #f7f1e3;
            --text-primary: #5d4037;
            --text-secondary: #8d6e63;
            --accent-red: #c0392b;
            --sidebar-width: 260px;
            /* Sidebar Defaults */
            --sidebar-bg: linear-gradient(to bottom, #3e2723, #281815);
            --sidebar-border: 1px solid #1a100d;
            --sidebar-texture: none;
            --sidebar-deco-color: rgba(0, 0, 0, 0.2);
            --sidebar-text: #d7ccc8;
        }

        /* Themes */
        /* 1. Vintage (时光旧物) */
        /* 1. Vintage (时光旧物) - 磨砂皮 + 圆柱光影 */
        body[data-theme='vintage'] {
            --bg-wood: #3E2723;
            --bg-leather: #5D4037;
            --paper-color: #F4ECD8;
            --text-primary: #2C3E50;
            --text-secondary: #5D4037;
            --accent-red: #8D6E63;

            /* Premium Polish */
            --sidebar-bg: linear-gradient(to right, #5d4037 0%, #4e342e 40%, #3e2723 100%);
            --sidebar-border: none;
            --sidebar-text: #efebe9;
            --sidebar-texture: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            --sidebar-deco-color: rgba(0, 0, 0, 0.3);
        }

        /* 2. Sea of Flowers (海底花海) */
        /* 2. Sea of Flowers (海底花海) - 梦幻粉色 + 深度毛玻璃 + 动态水流 */
        /* 2. Sea of Flowers (海底花海) - 修正版：明亮、烂漫、深红侧栏 */
        body[data-theme='sea_flower'] {
            /* 核心变量 - 烂漫花海基调 */
            --bg-wood: #FFF0F5;
            /* 薰衣草/浅粉红晕 */
            --bg-leather: #FCE4EC;
            --paper-color: rgba(255, 255, 255, 0.85);
            /* 纯白高透玻璃 */
            --text-primary: #880E4F;
            /* 深紫红色，确保高对比 */
            --text-secondary: #C2185B;
            /* 亮洋红 */
            --accent-red: #F50057;
            /* 鲜艳的玫瑰红点缀 */

            /* Sidebar Variables - 深沉质感 (红丝绒/干枯玫瑰) */
            --sidebar-bg: rgba(136, 14, 79, 0.85);
            /* 极深洋红/酒红，高浓度磨砂 */
            --sidebar-border: 1px solid rgba(255, 255, 255, 0.2);
            --sidebar-text: #F8BBD0;
            /* 浅粉色文字，在深底上清晰 */
            --sidebar-deco-color: rgba(255, 255, 255, 0.3);


            /* Sidebar Texture: 简单的光影纹理 */
            --sidebar-texture: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);

            /* Dynamic Background: 海底花海新色卡渐变 */
            background: linear-gradient(135deg,
                    #FEFDFF 0%,
                    /* 最浅亮色-左下 */
                    #F6D9E6 30%,
                    /* 浅粉-中下 */
                    #DBBAD0 60%,
                    /* 中粉-中上 */
                    #CDA8C7 100%);
            /* 深粉紫-右上 */
            background-attachment: fixed;
        }

        /* [Theme Component Overrides: Sea of Flowers - Bright & Romantic] */

        /* 1. Sidebar - Glassmorphism (毛玻璃拟态) */
        body[data-theme='sea_flower'] .sidebar {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.15) !important;
            /* 极淡的白色透明底 */
            box-shadow: none !important;
            /* 去掉侧边栏阴影 */
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            /* 精致边框 */
        }

        /* 移除主区域暗角,保持背景通透纯净 */
        body[data-theme='sea_flower'] .list-view {
            box-shadow: none !important;
        }

        body[data-theme='sea_flower'] .sidebar::after {
            /* 移除之前的深色底纹，改用光泽感 */
            content: none;
        }

        body[data-theme='sea_flower'] .app-name-zh {
            color: #880E4F;
            /* 深紫红色,在浅色背景上清晰 */
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            font-weight: 900;
        }

        body[data-theme='sea_flower'] .app-name-en {
            color: #C2185B;
            /* 适中的洋红色 */
            font-weight: 500;
            opacity: 0.8;
        }

        body[data-theme='sea_flower'] .logo-text {
            color: #8E24AA;
            /* 紫粉色logo */
            font-weight: 700;
        }

        body[data-theme='sea_flower'] .menu-item {
            color: #AD1457;
            /* 深粉红色 */
            margin: 0 12px;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        /* Footer Hitokoto Text Coordination */
        body[data-theme='sea_flower'] #hitokoto-text,
        body[data-theme='sea_flower'] #hitokoto-author {
            color: #C2185B !important;
            /* 深粉红色 */
            opacity: 0.6;
            /* 降低透明度至60% */
            text-shadow: none;
        }

        body[data-theme='sea_flower'] .menu-item:hover {
            background: rgba(194, 24, 91, 0.15);
            /* 深粉红半透明 */
            box-shadow: 0 2px 8px rgba(194, 24, 91, 0.2);
            color: #880E4F;
            /* 深紫红 */
        }

        body[data-theme='sea_flower'] .menu-item.active {
            background: linear-gradient(135deg, #EC407A, #C2185B);
            /* 亮眼的粉红渐变 */
            color: #FFF;
            box-shadow: 0 4px 15px rgba(233, 30, 99, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        body[data-theme='sea_flower'] .btn-new-diary {
            background: linear-gradient(135deg, rgba(255, 182, 193, 0.95) 0%, rgba(240, 98, 146, 0.9) 100%);
            /* 保持原有浅玫红→深粉色渐变 */
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 6px 16px rgba(240, 98, 146, 0.35),
                0 0 20px rgba(232, 145, 197, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.5);
            /* 添加外辉光效果 */
            color: #fff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);
        }

        body[data-theme='sea_flower'] .btn-new-diary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(233, 30, 99, 0.5),
                0 0 30px rgba(232, 145, 197, 0.6);
            /* 悬停时辉光增强 */
            filter: brightness(1.05);
        }

        body[data-theme='sea_flower'] .search-box {
            background: rgba(194, 24, 91, 0.08);
            /* 淡粉红半透明 */
            border: 1px solid rgba(194, 24, 91, 0.2);
            box-shadow: inset 0 1px 3px rgba(194, 24, 91, 0.1);
        }

        body[data-theme='sea_flower'] .search-input {
            color: #880E4F;
            /* 深紫红 */
        }

        body[data-theme='sea_flower'] .search-input::placeholder {
            color: rgba(136, 14, 79, 0.4);
            /* 深色占位符 */
        }

        body[data-theme='sea_flower'] .nav-item {
            color: #8E24AA;
            /* 深紫色菜单 */
            font-weight: 600;
            transition: all 0.2s ease;
        }

        body[data-theme='sea_flower'] .nav-item:hover {
            background: rgba(232, 145, 197, 0.2);
            /* 粉紫色悬停背景 */
            color: #7B1FA2;
            /* 深紫色 */
            transform: translateX(3px);
        }

        /* 2. Cards - Crystal Clear & Airy */
        body[data-theme='sea_flower'] .card {
            background: rgba(255, 255, 255, 0.35);
            /* 半透明白色 */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(200, 150, 200, 0.2);
            /* 粉紫色阴影 */
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
        }

        body[data-theme='sea_flower'] .card:hover {
            transform: translateY(-8px) scale(1.02);
            background: rgba(255, 255, 255, 0.45);
            box-shadow: 0 12px 40px rgba(200, 150, 200, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* Decorative Watermark for Cards - 粉紫色花朵辉光 */
        body[data-theme='sea_flower'] .card::after {
            content: '✿';
            position: absolute;
            bottom: -8px;
            right: -2px;
            font-size: 55px;
            background: linear-gradient(135deg, #E891C5, #C77FB5);
            /* 粉紫色渐变 */
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            opacity: 0.2;
            /* 提高可见度 */
            filter: blur(0px) drop-shadow(0 0 8px rgba(232, 145, 197, 0.3));
            /* 添加柔和辉光 */
            pointer-events: none;
            transition: all 0.5s ease;
        }

        body[data-theme='sea_flower'] .card:hover::after {
            opacity: 0.5;
            transform: scale(1.15) rotate(20deg);
            filter: blur(0px) drop-shadow(0 0 12px rgba(232, 145, 197, 0.5));
            /* 悬停时辉光增强 */
            right: 8px;
            bottom: 2px;
        }

        body[data-theme='sea_flower'] .card-meta {
            border-bottom: 1px solid rgba(194, 24, 91, 0.2) !important;
            color: #C2185B !important;
            /* 粉紫红色,与侧边栏协调 */
            opacity: 0.85;
        }

        body[data-theme='sea_flower'] .card-title {
            font-family: 'Noto Serif SC', serif;
            letter-spacing: 1px;
            color: #AD1457 !important;
            /* 深玫红色,与侧边栏菜单一致 */
            text-shadow: none;
        }

        body[data-theme='sea_flower'] .card-date {
            color: rgba(173, 20, 87, 0.75) !important;
            /* 半透明深玫红色 */
        }

        body[data-theme='sea_flower'] .card-preview,
        body[data-theme='sea_flower'] .card-excerpt {
            color: rgba(173, 20, 87, 0.7) !important;
            /* 预览文字,稍淡 */
        }

        /* 3. Editor & Reader Areas - 粉紫主题适配 */
        body[data-theme='sea_flower'] .full-page-view {
            background: transparent;
            /* 透明背景,显示主背景渐变 */
        }

        body[data-theme='sea_flower'] .editor-top-bar {
            background: rgba(255, 255, 255, 0.35);
            /* 半透明毛玻璃 */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(199, 127, 181, 0.3);
            box-shadow: 0 2px 8px rgba(200, 150, 200, 0.15);
        }

        body[data-theme='sea_flower'] .btn-back,
        body[data-theme='sea_flower'] .btn-edit,
        body[data-theme='sea_flower'] .btn-delete {
            color: #AD1457;
            /* 深玫红色,增强可读性 */
            font-size: 16px;
            /* 增大字号 */
            font-weight: 700;
            /* 加粗字体 */
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            /* 添加浅色文字阴影增强对比 */
            transition: all 0.2s ease;
        }

        /* 按钮hover状态 */
        body[data-theme='sea_flower'] .btn-back:hover,
        body[data-theme='sea_flower'] .btn-edit:hover,
        body[data-theme='sea_flower'] .btn-delete:hover {
            color: #D81B60;
            /* 悬停时颜色变亮 */
            transform: translateY(-1px);
            text-shadow: 0 2px 4px rgba(248, 187, 208, 0.4);
        }

        /* 按钮active状态 */
        body[data-theme='sea_flower'] .btn-back:active,
        body[data-theme='sea_flower'] .btn-edit:active,
        body[data-theme='sea_flower'] .btn-delete:active {
            color: #F06292;
            /* 点击时变为粉色 */
            transform: translateY(0);
        }

        body[data-theme='sea_flower'] .paper-sheet {
            background: rgba(255, 255, 255, 0.75);
            /* 半透明白色 */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 20px 60px rgba(200, 150, 200, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: #7B1FA2;
            /* 深紫色文字 */
        }

        body[data-theme='sea_flower'] .paper-sheet::before {
            background: linear-gradient(90deg, #FFB6C1, #F8BBD0, #F8BBD0, #FFB6C1);
            /* 浅粉色渐变 */
            box-shadow: 0 2px 6px rgba(248, 187, 208, 0.25);
        }

        body[data-theme='sea_flower'] .ribbon {
            background: linear-gradient(to bottom, #FFB6C1, #F8BBD0);
            /* 浅粉色渐变 */
            box-shadow: 0 4px 12px rgba(248, 187, 208, 0.35);
            border-left: 1px solid rgba(255, 255, 255, 0.5);
            border-right: 1px solid rgba(255, 255, 255, 0.5);
        }

        body[data-theme='sea_flower'] .ribbon::after {
            border-left-color: #F8BBD0;
            border-right-color: #F8BBD0;
        }

        body[data-theme='sea_flower'] textarea.edit-content,
        body[data-theme='sea_flower'] .read-body {
            color: #4A235A;
            background-image: linear-gradient(transparent 31px, rgba(233, 30, 99, 0.05) 32px);
            /* 极淡的粉色线 */
        }

        body[data-theme='sea_flower'] .edit-title,
        body[data-theme='sea_flower'] .read-title {
            color: #880E4F;
            text-shadow: none;
        }

        body[data-theme='sea_flower'] input.edit-title::placeholder {
            color: rgba(136, 14, 79, 0.3);
        }

        /* 完成按钮适配 - 浅粉色系 */
        body[data-theme='sea_flower'] .btn-done {
            background: linear-gradient(to bottom, #FFD1DC, #F8BBD0);
            /* 浅粉色渐变 */
            border: 1px solid rgba(248, 187, 208, 0.6);
            color: #AD1457;
            /* 深玫红色文字 */
            box-shadow: 0 2px 6px rgba(248, 187, 208, 0.3);
            font-weight: bold;
            transition: all 0.2s ease;
        }

        body[data-theme='sea_flower'] .btn-done:hover {
            background: linear-gradient(to bottom, #FFB6C1, #F48FB1);
            /* 悬停时颜色稍深 */
            border-color: rgba(240, 98, 146, 0.7);
            box-shadow: 0 3px 8px rgba(240, 98, 146, 0.35);
            transform: translateY(-1px);
        }

        body[data-theme='sea_flower'] .btn-done:active {
            background: linear-gradient(to bottom, #F8BBD0, #F48FB1);
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(240, 98, 146, 0.3);
        }

        /* 顶栏按钮字体优化 - icon-btn和back-link */
        body[data-theme='sea_flower'] .icon-btn,
        body[data-theme='sea_flower'] .back-link {
            color: #AD1457;
            /* 深玫红色 */
            font-size: 16px;
            /* 增大字号 */
            font-weight: 700;
            /* 加粗字体 */
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
            /* 浅色阴影增强对比 */
            opacity: 1;
            /* 去掉默认透明度 */
        }

        body[data-theme='sea_flower'] .icon-btn:hover,
        body[data-theme='sea_flower'] .back-link:hover {
            color: #D81B60;
            /* 悬停时颜色变亮 */
            text-shadow: 0 2px 4px rgba(248, 187, 208, 0.4);
            transform: translateY(-1px);
        }

        body[data-theme='sea_flower'] .icon-btn:active,
        body[data-theme='sea_flower'] .back-link:active {
            color: #F06292;
            /* 点击时变为粉色 */
            transform: translateY(0);
        }

        body[data-theme='sea_flower'] .icon-btn.delete:hover {
            color: #F06292;
            /* 删除按钮悬停时粉色 */
        }



        /* 动态花瓣雨背景动画 (Petal Rain with Depth of Field) */
        body[data-theme='sea_flower'] .petal-rain-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            /* 不拦截鼠标事件 */
            z-index: 0;
            /* 最底层 */
            overflow: hidden;
        }

        body[data-theme='sea_flower'] .petal {
            position: absolute;
            font-size: var(--petal-size);
            /* 使用字体大小控制花朵大小 */
            color: var(--petal-color);
            /* 花朵颜色 */
            filter: blur(var(--petal-blur)) drop-shadow(0 2px 4px rgba(240, 98, 146, 0.3));
            /* 景深模糊 + 阴影 */
            opacity: var(--petal-opacity);
            /* 景深透明度 */
            animation: petalFall var(--petal-duration) linear infinite;
            animation-delay: var(--petal-delay);
            transform-origin: center;
            user-select: none;
            /* 防止选中 */
        }

        /* 花朵符号内容通过伪元素添加 */
        body[data-theme='sea_flower'] .petal::before {
            content: '✿';
            display: block;
        }

        /* 花瓣下落动画 - 左右摇摆的水流感 */
        @keyframes petalFall {
            0% {
                transform: translateY(-20vh) translateX(0) rotate(0deg);
                opacity: 0;
            }

            5% {
                opacity: var(--petal-opacity);
            }

            25% {
                transform: translateY(25vh) translateX(25px) rotate(90deg);
            }

            50% {
                transform: translateY(50vh) translateX(-15px) rotate(180deg);
            }

            75% {
                transform: translateY(75vh) translateX(30px) rotate(270deg);
            }

            95% {
                opacity: var(--petal-opacity);
            }

            100% {
                transform: translateY(115vh) translateX(0) rotate(360deg);
                opacity: 0;
            }
        }


        /* 3. Midnight (午夜星尘) - 沉浸式动态星空 + 暗色拟物 */
        body[data-theme='midnight'] {
            /* 核心变量 */
            --bg-wood: #050510;
            --bg-leather: #0a0a14;
            --paper-color: #161b22;
            /* 深色信纸 */
            --text-primary: #e6edf3;
            /* 柔和白 */
            --text-secondary: #8b949e;
            /* 银灰 */
            --accent-red: #7986cb;
            /* Revised: 沉稳的靛蓝色 (Muted Indigo) */

            /* Sidebar Variables */
            --sidebar-bg: rgba(13, 17, 23, 0.7);
            /* 增加透明度 */
            --sidebar-border: none;
            --sidebar-text: #c9d1d9;
            --sidebar-texture: none;
            /* 去除旧纹理，依靠背景透视 */
            --sidebar-deco-color: rgba(121, 134, 203, 0.2);

            /* Dynamic Starry Background (All Stars) */
            background-image: url("data:image/svg+xml,%3Csvg width='100%25' height='100%25' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3CradialGradient id='sky' cx='50%25' cy='100%25' r='120%25' fx='50%25' fy='100%25'%3E%3Cstop offset='0%25' stop-color='%231a237e' /%3E%3Cstop offset='50%25' stop-color='%23050510' /%3E%3Cstop offset='100%25' stop-color='%23000000' /%3E%3C/radialGradient%3E%3Csymbol id='star' viewBox='0 0 24 24'%3E%3Cpath d='M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z' fill='white' /%3E%3C/symbol%3E%3Cfilter id='glow'%3E%3CfeGaussianBlur stdDeviation='1.5' result='coloredBlur'/%3E%3CfeMerge%3E%3CfeMergeNode in='coloredBlur'/%3E%3CfeMergeNode in='SourceGraphic'/%3E%3C/feMerge%3E%3C/filter%3E%3C/defs%3E%3Crect width='100%25' height='100%25' fill='url(%23sky)' /%3E%3C!-- Hanging Strings --%3E%3Cg stroke='rgba(255,255,255,0.1)' stroke-width='1'%3E%3Cline x1='15%25' y1='0' x2='15%25' y2='30%25' /%3E%3Cline x1='35%25' y1='0' x2='35%25' y2='50%25' /%3E%3Cline x1='60%25' y1='0' x2='60%25' y2='25%25' /%3E%3Cline x1='80%25' y1='0' x2='80%25' y2='40%25' /%3E%3Cline x1='50%25' y1='0' x2='50%25' y2='15%25' /%3E%3C/g%3E%3C!-- Hanging Stars --%3E%3Cg filter='url(%23glow)'%3E%3Cuse href='%23star' x='13.5%25' y='28%25' width='3%25' height='3%25' opacity='0.9'%3E%3Canimate attributeName='opacity' values='0.4;1;0.4' dur='4s' repeatCount='indefinite' /%3E%3CanimateTransform attributeName='transform' type='rotate' from='0 15%25 30%25' to='5 15%25 30%25' dur='5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='33.5%25' y='48%25' width='3.5%25' height='3.5%25' opacity='1'%3E%3Canimate attributeName='opacity' values='0.5;1;0.5' dur='3s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='58.8%25' y='23%25' width='2.5%25' height='2.5%25' opacity='0.8'%3E%3Canimate attributeName='opacity' values='0.3;0.9;0.3' dur='5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='78.5%25' y='38%25' width='3%25' height='3%25' opacity='0.9'%3E%3Canimate attributeName='opacity' values='0.2;1;0.2' dur='3.5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='49%25' y='13%25' width='2%25' height='2%25' opacity='0.7'%3E%3Canimate attributeName='opacity' values='0.4;0.8;0.4' dur='4.5s' repeatCount='indefinite' /%3E%3C/use%3E%3C/g%3E%3C!-- Background Tiny Stars (All Stars Now) --%3E%3Cg filter='url(%23glow)'%3E%3Cuse href='%23star' x='10%25' y='60%25' width='1.5%25' height='1.5%25'%3E%3Canimate attributeName='opacity' values='0;1;0' dur='3s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='90%25' y='80%25' width='2%25' height='2%25'%3E%3Canimate attributeName='opacity' values='0;0.8;0' dur='4s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='25%25' y='90%25' width='1.2%25' height='1.2%25'%3E%3Canimate attributeName='opacity' values='0;0.6;0' dur='5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='70%25' y='10%25' width='1.5%25' height='1.5%25'%3E%3Canimate attributeName='opacity' values='0;0.9;0' dur='2.5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='5%25' y='40%25' width='1.8%25' height='1.8%25'%3E%3Canimate attributeName='opacity' values='0;0.7;0' dur='3.5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='85%25' y='5%25' width='1.5%25' height='1.5%25'%3E%3Canimate attributeName='opacity' values='0;0.8;0' dur='4.5s' repeatCount='indefinite' /%3E%3C/use%3E%3Cuse href='%23star' x='40%25' y='95%25' width='1.2%25' height='1.2%25'%3E%3Canimate attributeName='opacity' values='0;0.5;0' dur='6s' repeatCount='indefinite' /%3E%3C/use%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: cover;
            background-attachment: fixed;
            /* 固定背景 */
        }

        /* Midnight Specific Component Overrides */

        /* 1. Sidebar - Glassmorphism & Neon */
        body[data-theme='midnight'] .sidebar {
            backdrop-filter: blur(15px);
            background: var(--sidebar-bg);
            /* Use rgba */
            box-shadow: 1px 0 20px rgba(0, 0, 0, 0.3);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            /* Subtle border for definition */
        }

        body[data-theme='midnight'] .btn-new-diary {
            background: linear-gradient(135deg, #5c6bc0 0%, #3949ab 100%);
            border: none;
            box-shadow: 0 4px 15px rgba(132, 70, 240, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.2);
            font-weight: 600;
            letter-spacing: 1px;
        }

        body[data-theme='midnight'] .btn-new-diary:hover {
            box-shadow: 0 6px 20px rgba(132, 70, 240, 0.6), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            filter: brightness(1.1);
        }

        body[data-theme='midnight'] .search-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: none;
        }

        body[data-theme='midnight'] .search-input::placeholder {
            color: rgba(201, 209, 217, 0.4);
        }

        body[data-theme='midnight'] .menu-item.active {
            background-color: rgba(121, 134, 203, 0.25);
            /* Muted Indigo Tint */
            border-left: none;
            /* Remove border to match default logic */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            color: #fff;
            font-weight: bold;
        }

        /* 2. Cards - Floating Dark Matter */
        body[data-theme='midnight'] .card {
            background-image: none;
            /* Remove parchment texture */
            background-color: var(--paper-color);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
        }

        body[data-theme='midnight'] .card-meta {
            color: #6e7681;
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        /* [Decor] Card Star Shine */
        /* [Decor] Card Star Shine */
        body[data-theme='midnight'] .card {
            position: relative;
            /* Ensure absolute child aligns */
            /* Gradient transparency: Top-Left (Less Transparent) -> Bottom-Right (More Transparent) */
            background: linear-gradient(135deg, rgba(30, 37, 46, 0.85) 0%, rgba(22, 27, 34, 0.45) 100%);
            backdrop-filter: blur(10px);
            /* Glass effect */
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(121, 134, 203, 0.2);
            transition: all 0.3s ease;
        }

        body[data-theme='midnight'] .card::after {
            content: '✦';
            position: absolute;
            bottom: 15px;
            /* Moved to bottom */
            right: 20px;
            /* Moved to right */
            top: auto;
            /* Reset top */
            font-size: 24px;
            /* Slightly larger */
            color: rgba(121, 134, 203, 0.3);
            /* Idle state: Dim Muted Indigo */
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-shadow: none;
            pointer-events: none;
            transform: scale(1) rotate(0deg);
        }

        body[data-theme='midnight'] .card:hover::after {
            color: #fff;
            text-shadow: 0 0 10px #7986cb, 0 0 20px #fff;
            /* Bright Glow */
            transform: scale(1.3) rotate(180deg);
            /* Rotate animation */
            opacity: 1;
        }

        body[data-theme='midnight'] .card:hover {
            border-color: rgba(121, 134, 203, 0.4);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6),
                inset 0 0 20px rgba(0, 0, 0, 0.2),
                0 0 30px rgba(121, 134, 203, 0.1);
            /* Subtle aura */
            transform: translateY(-5px);
            z-index: 5;
        }

        /* [Fix] Card Title Visibility */
        body[data-theme='midnight'] .card-title {
            color: #e6edf3;
        }

        /* 3. Editor Paper - Dark Sheet */
        body[data-theme='midnight'] .paper-sheet {
            background-image: none;
            background-color: var(--paper-color);
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        body[data-theme='midnight'] .paper-sheet::before {
            background-color: #5c6bc0;
            /* Revised: Muted Blue Header */
            box-shadow: 0 0 10px rgba(92, 107, 192, 0.5);
        }

        body[data-theme='midnight'] .ribbon {
            background-color: #3949ab;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
        }

        body[data-theme='midnight'] .ribbon::after {
            border-left-color: #3949ab;
            border-right-color: #3949ab;
        }

        body[data-theme='midnight'] .edit-title,
        body[data-theme='midnight'] .read-title {
            color: #e6edf3 !important;
            /* Force override */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        body[data-theme='midnight'] input.edit-title::placeholder {
            color: rgba(139, 148, 158, 0.5);
        }

        body[data-theme='midnight'] .divider-line {
            background-color: rgba(255, 255, 255, 0.1);
        }

        body[data-theme='midnight'] textarea.edit-content,
        body[data-theme='midnight'] .read-body {
            color: var(--text-primary);
            /* Adjust lines for dark mode */
            background-image: linear-gradient(transparent 31px, rgba(255, 255, 255, 0.05) 32px);
        }

        body[data-theme='midnight'] .btn-done {
            background: linear-gradient(to bottom, #21262d, #161b22);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #c9d1d9;
        }

        body[data-theme='midnight'] .btn-done:hover {
            border-color: #8b949e;
            color: #fff;
        }

        /* [Fix] Editor Top Bar */
        body[data-theme='midnight'] .editor-top-bar {
            background-color: rgba(5, 5, 16, 0.85);
            /* Darker Match */
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(15px);
        }

        /* [Fix] Selector Colors */
        body[data-theme='midnight'] .select-clean {
            color: #c9d1d9;
            background-color: transparent;
            /* Or darker if needed */
            color-scheme: dark;
            /* Force browser to use dark dropdown */
        }

        body[data-theme='midnight'] .select-clean option {
            background-color: #161b22;
            color: #c9d1d9;
        }

        /* [Fix] Flatpickr Calendar Adaptation */
        body[data-theme='midnight'] .flatpickr-calendar {
            background: rgba(22, 27, 34, 0.95) !important;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            backdrop-filter: blur(10px);
        }

        body[data-theme='midnight'] .flatpickr-months .flatpickr-month,
        body[data-theme='midnight'] .flatpickr-weekdays {
            background: transparent !important;
            color: #e6edf3 !important;
        }

        body[data-theme='midnight'] .flatpickr-monthDropdown-months {
            background: #161b22 !important;
            color: #e6edf3 !important;
        }

        body[data-theme='midnight'] .flatpickr-monthDropdown-months:hover {
            background: #21262d !important;
        }

        body[data-theme='midnight'] .flatpickr-current-month input.cur-year {
            color: #e6edf3 !important;
        }

        body[data-theme='midnight'] .flatpickr-day {
            color: #c9d1d9 !important;
        }

        body[data-theme='midnight'] .flatpickr-day:hover,
        body[data-theme='midnight'] .flatpickr-day.prevMonthDay:hover,
        body[data-theme='midnight'] .flatpickr-day.nextMonthDay:hover,
        body[data-theme='midnight'] .flatpickr-day:focus {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: transparent !important;
        }

        body[data-theme='midnight'] .flatpickr-day.selected {
            background: var(--accent-red) !important;
            border-color: var(--accent-red) !important;
            color: #fff !important;
            box-shadow: 0 0 10px rgba(121, 134, 203, 0.4);
        }

        body[data-theme='midnight'] .flatpickr-prev-month,
        body[data-theme='midnight'] .flatpickr-next-month {
            fill: #e6edf3 !important;
            color: #e6edf3 !important;
        }

        /* Dropdown arrow fix */
        body[data-theme='midnight'] .flatpickr-current-month .numInputWrapper span.arrowUp:after {
            border-bottom-color: #e6edf3 !important;
        }

        body[data-theme='midnight'] .flatpickr-current-month .numInputWrapper span.arrowDown:after {
            border-top-color: #e6edf3 !important;
        }

        /* Update Modal - Universal Skeuomorphic Design */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .update-card {
            background-color: #f7f1e3;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            width: 400px;
            padding: 30px;
            border-radius: 4px;
            box-shadow:
                0 20px 50px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.5) inset;
            border: 1px solid #d7ccc8;
            position: relative;
            transform: rotate(-1deg);
            color: #5d4037;
            font-family: 'Noto Serif SC', serif;
        }

        /* Wax Seal Decoration */
        .wax-seal {
            position: absolute;
            top: -15px;
            right: -15px;
            width: 60px;
            height: 60px;
            background: #c0392b;
            border-radius: 50%;
            box-shadow:
                inset 2px 2px 5px rgba(255, 255, 255, 0.3),
                inset -2px -2px 5px rgba(0, 0, 0, 0.3),
                0 5px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transform: rotate(15deg);
            border: 2px dashed rgba(255, 255, 255, 0.2);
        }

        .wax-seal span {
            color: rgba(255, 255, 255, 0.9);
            font-weight: bold;
            font-size: 12px;
            letter-spacing: 1px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }

        .card-header h2 {
            margin: 0;
            font-size: 24px;
            text-align: center;
            color: #3e2723;
            letter-spacing: 2px;
        }

        .divider {
            height: 2px;
            background: linear-gradient(to right, transparent, #8d6e63, transparent);
            margin: 15px 0 20px 0;
            opacity: 0.5;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .feature-list li {
            display: flex;
            align-items: flex-start;
            margin-bottom: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.4);
            border-radius: 8px;
            border: 1px solid rgba(141, 110, 99, 0.1);
        }

        .feature-list .icon {
            font-size: 24px;
            margin-right: 15px;
            filter: drop-shadow(0 2px 2px rgba(0, 0, 0, 0.2));
        }

        .feature-list .details strong {
            display: block;
            font-size: 16px;
            margin-bottom: 4px;
            color: #3e2723;
        }

        .feature-list .details p {
            margin: 0;
            font-size: 13px;
            color: #5d4037;
            opacity: 0.8;
        }

        .card-footer {
            margin-top: 25px;
            text-align: center;
        }

        .btn-confirm {
            background: #5d4037;
            color: #f7f1e3;
            border: none;
            padding: 10px 40px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
            background: #4e342e;
        }

        .btn-confirm:active {
            transform: translateY(0);
        }

        body {
            font-family: 'Noto Serif SC', "Songti SC", serif;
            background: var(--bg-wood);
            background-size: cover;
            margin: 0;
            height: 100vh;
            display: flex;
            overflow: hidden;
            color: var(--text-primary);
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        /* 侧边栏 */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--sidebar-bg);
            border-right: var(--sidebar-border);
            box-shadow: inset -2px 0 10px rgba(0, 0, 0, 0.2);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            padding: 30px 20px;
            z-index: 10;
            position: relative;
            overflow: hidden;
            /* For texture containment */
            transition: all 0.3s ease;
        }

        /* Sidebar Texture/Decoration Layer */
        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--sidebar-texture);
            opacity: 0.8;
            pointer-events: none;
            z-index: 0;
        }

        /* Special Decor for Zen (Binding Line) */
        body[data-theme='zen'] .sidebar::after {
            content: '';
            position: absolute;
            top: 0;
            right: 15px;
            width: 2px;
            height: 100%;
            border-right: 1px dashed #cfd8dc;
            /* Stitching line */
            z-index: 1;
        }

        /* Special Decor for Midnight (Glow Border) */
        body[data-theme='midnight'] .sidebar {
            box-shadow: 1px 0 15px rgba(0, 0, 0, 0.5), inset -1px 0 0 var(--sidebar-deco-color);
        }

        /* Ensure content is above texture */
        .sidebar-header,
        .sidebar-tools,
        .sidebar-menu {
            position: relative;
            z-index: 2;
        }

        /* LOGO: 纯文字，精致排版 */
        .sidebar-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 35px;
            padding-left: 5px;
        }

        .app-name-zh {
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
            color: #eefeeb;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .app-name-en {
            font-size: 12px;
            font-weight: normal;
            color: var(--sidebar-text);
            letter-spacing: 0.5px;
            opacity: 0.8;
            font-family: 'Noto Serif SC', serif;
        }

        .sidebar-tools {
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* 按钮：写一篇 */
        .btn-new-diary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background: var(--accent-red);
            color: #fff;
            font-weight: bold;
            text-decoration: none;
            padding: 12px;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 2;
        }

        .btn-new-diary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            filter: brightness(1.1);
        }

        .btn-new-diary:active {
            transform: translateY(0);
        }

        /* 搜索框：极简无图标 */
        .search-box {
            display: flex;
            background: rgba(0, 0, 0, 0.25);
            border-radius: 6px;
            padding: 2px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
            position: relative;
            z-index: 2;
        }

        .search-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: var(--sidebar-text);
            padding: 10px 12px;
            font-family: inherit;
            font-size: 14px;
            outline: none;
            text-align: left;
        }

        .search-input::placeholder {
            color: var(--sidebar-text);
            opacity: 0.5;
            font-size: 13px;
        }

        .sidebar-menu {
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-grow: 1;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 20px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 15px;
            color: var(--sidebar-text);
            opacity: 0.8;
            cursor: pointer;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            opacity: 1;
        }

        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            opacity: 1;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .menu-icon {
            font-size: 18px;
            opacity: 0.8;
        }

        /* 主区域 */
        .main-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        .list-view {
            flex-grow: 1;
            overflow-y: auto;
            padding: 40px;
            /* 移除暗角阴影 */
        }

        .waterfall {
            column-count: 3;
            column-gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        @media (max-width: 1100px) {
            .waterfall {
                column-count: 2;
            }
        }

        @media (max-width: 700px) {
            .waterfall {
                column-count: 1;
            }
        }

        /* 卡片 */
        .card {
            background-color: var(--paper-color);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            break-inside: avoid;
            margin-bottom: 30px;
            padding: 25px;
            position: relative;
            display: block;
            color: var(--text-primary);
            transition: transform 0.2s;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .card:hover {
            transform: translateY(-3px);
        }

        .card-meta {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed rgba(93, 64, 55, 0.15);
            padding-bottom: 5px;
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 12px;
            line-height: 1.4;
            padding-top: 5px;
        }

        .card-preview {
            font-size: 15px;
            line-height: 1.8;
            opacity: 0.9;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            line-clamp: 5;
            overflow: hidden;
        }

        /* 空状态 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
            opacity: 0.6;
            animation: fadeIn 1s ease;
        }

        .empty-icon {
            font-size: 60px;
            margin-bottom: 20px;
            filter: grayscale(100%) opacity(0.5);
        }

        .empty-text {
            font-size: 18px;
            color: var(--text-secondary);
            letter-spacing: 2px;
            font-style: italic;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 0.6;
                transform: translateY(0);
            }
        }

        /* 视图容器 */
        .full-page-view {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-wood);
            display: flex;
            flex-direction: column;
            z-index: 20;
        }

        .editor-top-bar {
            height: 60px;
            background-color: rgba(40, 24, 21, 0.75);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 30;
        }

        .back-link {
            display: flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            font-size: 15px;
            color: #d7ccc8;
            transition: color 0.2s;
            cursor: pointer;
            opacity: 0.9;
        }

        .back-link:hover {
            opacity: 1;
            color: #fff;
        }

        .btn-done {
            background: linear-gradient(to bottom, #fcfcfc, #e0e0e0);
            border: 1px solid #bdc3c7;
            color: var(--accent-red);
            font-weight: bold;
            padding: 6px 20px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.1s;
        }

        .btn-done:hover {
            background: #fff;
            transform: translateY(-1px);
        }

        .btn-done:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* 纸张 */
        .paper-container {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 40px;
            overflow-y: auto;
        }

        .paper-sheet {
            width: 700px;
            min-height: 85vh;
            background-color: var(--paper-color);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border-radius: 2px;
            padding: 60px 80px;
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 50px;
        }

        .paper-sheet::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background-color: var(--accent-red);
            opacity: 0.8;
            border-radius: 2px 2px 0 0;
        }

        .ribbon {
            position: absolute;
            top: -10px;
            right: 40px;
            width: 40px;
            height: 80px;
            background-color: var(--accent-red);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
            z-index: 50;
        }

        .ribbon::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 0;
            border-left: 20px solid var(--accent-red);
            border-right: 20px solid var(--accent-red);
            border-bottom: 20px solid transparent;
        }

        .ribbon-stitch {
            position: absolute;
            top: 0;
            left: 5px;
            right: 5px;
            bottom: 15px;
            border-left: 1px dashed rgba(255, 255, 255, 0.4);
            border-right: 1px dashed rgba(255, 255, 255, 0.4);
            pointer-events: none;
        }

        .edit-header {
            margin-bottom: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        input.edit-title {
            font-family: inherit;
            font-size: 36px;
            font-weight: bold;
            text-align: left;
            color: #2c241b;
            width: 100%;
            border: none;
            background: transparent;
            outline: none;
            padding: 0;
        }

        input.edit-title::placeholder {
            color: rgba(93, 64, 55, 0.3);
        }

        .meta-row {
            display: flex;
            gap: 40px;
            align-items: flex-start;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .meta-label {
            font-size: 10px;
            font-weight: bold;
            color: #a1887f;
            letter-spacing: 1px;
            text-transform: uppercase;
            font-family: sans-serif;
        }

        .divider-line {
            width: 100%;
            height: 1px;
            background-color: rgba(93, 64, 55, 0.15);
            margin-bottom: 30px;
        }

        textarea.edit-content {
            width: 100%;
            min-height: 500px;
            font-family: inherit;
            font-size: 18px;
            line-height: 32px;
            color: #3e332a;
            border: none;
            background: transparent;
            outline: none;
            resize: none;
            overflow: hidden;
            background-image: linear-gradient(transparent 31px, rgba(93, 64, 55, 0.12) 32px);
            background-size: 100% 32px;
            background-attachment: local;
            background-position-y: -1px;
            padding-top: 0;
        }

        .read-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .read-title {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c241b;
        }

        .read-meta {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            color: var(--text-secondary);
            display: flex;
            justify-content: center;
            gap: 15px;
            align-items: center;
        }

        .meta-separator {
            opacity: 0.5;
        }

        .decorative-line {
            width: 60px;
            height: 4px;
            background-color: var(--accent-red);
            margin: 25px auto 0;
            opacity: 0.6;
            border-radius: 2px;
        }

        .read-body {
            font-size: 18px;
            line-height: 32px;
            color: #3e332a;
            flex-grow: 1;
            white-space: pre-wrap;
            background-image: linear-gradient(transparent 31px, rgba(93, 64, 55, 0.12) 32px);
            background-size: 100% 32px;
            background-position-y: -1px;
            padding-top: 0;
        }

        /* Markdown Styles - Strict Vertical Rhythm */
        .read-body p {
            margin-top: 0;
            margin-bottom: 32px;
            line-height: 32px;
        }

        .read-body ul,
        .read-body ol,
        .read-body blockquote {
            margin-top: 0;
            margin-bottom: 32px;
            line-height: 32px;
        }

        .read-body h1,
        .read-body h2,
        .read-body h3,
        .read-body h4 {
            margin-top: 32px;
            margin-bottom: 32px;
            font-weight: bold;
            line-height: 32px;
        }

        .read-body blockquote {
            border-left: 5px solid var(--accent-red);
            padding-left: 15px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .read-body img {
            max-width: 100%;
            border-radius: 4px;
            /* Soft edges */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            margin: 32px 0;
            display: block;
        }

        .read-body ul,
        .read-body ol {
            padding-left: 2em;
        }

        .read-body pre {
            background: rgba(0, 0, 0, 0.05);
            padding: 16px;
            border-radius: 4px;
            overflow-x: auto;
            margin-bottom: 32px;
        }

        .read-body code {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 2px 5px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .read-footer {
            margin-top: 60px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .created-with span {
            font-family: 'Noto Serif SC', serif;
            font-weight: bold;
            color: var(--text-primary);
            font-size: 14px;
            letter-spacing: 1px;
        }

        /* 字体修复 */

        .action-btn-group {
            display: flex;
            gap: 15px;
        }

        .icon-btn {
            font-size: 18px;
            cursor: pointer;
            transition: color 0.2s;
            opacity: 0.8;
            background: none;
            border: none;
            color: #d7ccc8;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .icon-btn:hover {
            color: #fff;
            opacity: 1;
        }

        .icon-btn.delete:hover {
            color: #ff6b6b;
        }

        .date-input-clean {
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            background: transparent;
            border: none;
            cursor: pointer;
            width: 110px;
            outline: none;
            text-align: left;
        }

        .select-clean {
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            background: transparent;
            border: none;
            cursor: pointer;
            outline: none;
            appearance: none;
            padding-right: 15px;
        }

        /* Flatpickr */
        .flatpickr-calendar {
            background: var(--paper-color) !important;
            border: 1px solid #d7ccc8 !important;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4) !important;
            font-family: 'Noto Serif SC', serif !important;
            border-radius: 4px !important;
            width: auto !important;
            padding: 5px !important;
        }

        .flatpickr-months {
            background: var(--bg-leather) !important;
            color: #fff !important;
            padding-top: 5px;
            border-radius: 4px 4px 0 0;
        }

        .flatpickr-months .flatpickr-month {
            color: #d7ccc8 !important;
            fill: #d7ccc8 !important;
        }

        .flatpickr-weekdays {
            background: var(--bg-leather) !important;
        }

        span.flatpickr-weekday {
            color: #a1887f !important;
            font-weight: bold !important;
        }

        .flatpickr-day {
            color: var(--text-primary) !important;
            font-weight: bold;
            border-radius: 4px !important;
        }

        .flatpickr-day:hover {
            background: #e0d8c0 !important;
            border-color: transparent !important;
        }

        .flatpickr-day.selected {
            background: var(--accent-red) !important;
            border-color: var(--accent-red) !important;
            color: #fff !important;
        }

        .flatpickr-day.today {
            border-color: transparent !important;
            border-bottom: 2px solid var(--accent-red) !important;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        /* SVG 图标 */
        .sys-icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            vertical-align: text-bottom;
            fill: none;
            stroke: currentColor;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .edit-icon-wrapper .sys-icon {
            width: 24px;
            height: 24px;
        }

        /* --- Theme Gallery Modal CSS --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .theme-gallery {
            background: var(--paper-color);
            padding: 40px;
            border-radius: 12px;
            width: 600px;
            max-width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .gallery-title {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 24px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .theme-card {
            background: rgba(0, 0, 0, 0.05);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .theme-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: rgba(0, 0, 0, 0.08);
        }

        .theme-card.active {
            border-color: var(--accent-red);
            background: rgba(var(--accent-red-rgb), 0.1);
            /* 需要确切的颜色处理，这里简化 */
            box-shadow: 0 0 0 4px rgba(0, 0, 0, 0.05);
        }

        .theme-preview-box {
            width: 100%;
            height: 80px;
            border-radius: 4px;
            margin-bottom: 5px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* Preview Patterns */
        .preview-default {
            background: radial-gradient(circle at 50% 50%, #4a3b32 0%, #2d241f 100%);
        }

        .preview-vintage {
            background: #3E2723;
        }

        .preview-sea_flower {
            background: linear-gradient(135deg, #F6D9E6, #DBBAD0);
        }

        .preview-midnight {
            background: #161B22;
        }

        .theme-name {
            font-weight: bold;
            color: var(--text-primary);
            font-size: 16px;
        }

        .theme-desc {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: center;
        }

        .close-gallery-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-gallery-btn:hover {
            color: var(--accent-red);
        }
    </style>
</head>

<body data-theme="{{ current_theme }}">
    <!-- 动态花瓣雨容器 (仅在海底花海主题下显示) -->
    <div class="petal-rain-container" id="petal-rain"></div>

    <div class="sidebar">
        <div class="sidebar-header">
            <span class="app-name-zh">纸语</span>
            <span class="app-name-en">PaperWhisper</span>
        </div>

        <div class="sidebar-tools">
            <a href="/?view=edit&new=true" class="btn-new-diary">
                <span>✎</span> 写一篇
            </a>

            <form action="/" method="GET" class="search-box">
                <input type="text" name="q" class="search-input" placeholder="搜索记忆碎片..."
                    value="{{ search_query if search_query else '' }}" autocomplete="off">
            </form>
        </div>

        <nav class="sidebar-menu">
            <a href="/" class="menu-item {% if show_list and not search_query %}active{% endif %}">
                <span class="menu-icon">≡</span> 全部便签
            </a>
            <a href="#" class="menu-item" onclick="openSettings()">
                <span class="menu-icon">⚙</span> 设置风格
            </a>

            <div id="hitokoto-container"
                style="margin-top: auto; font-size: 12px; color: rgba(255,255,255,0.5); padding: 15px; font-style: italic; border-top: 1px solid rgba(255,255,255,0.05);">
                <span id="hitokoto-text">正在获取一言...</span>
                <br>
                <span id="hitokoto-author" style="float: right; opacity: 0.7;"></span>
            </div>
        </nav>
    </div>

    <!-- Settings Modal -->
    <!-- Theme Gallery Modal -->
    <div id="settings-modal" class="modal-overlay" onclick="if(event.target === this) closeSettings()">
        <div class="theme-gallery">
            <button class="close-gallery-btn" onclick="closeSettings()">×</button>
            <h3 class="gallery-title">风格画廊</h3>

            <div class="theme-grid">
                <!-- 1. Default -->
                <div class="theme-card" onclick="setTheme('default')" id="card-default">
                    <div class="theme-preview-box preview-default"></div>
                    <div class="theme-name">经典木纹</div>
                    <div class="theme-desc">深色圆木，温润如玉</div>
                </div>

                <!-- 2. Vintage -->
                <div class="theme-card" onclick="setTheme('vintage')" id="card-vintage">
                    <div class="theme-preview-box preview-vintage"></div>
                    <div class="theme-name">时光旧物</div>
                    <div class="theme-desc">泛黄羊皮，怀旧岁月</div>
                </div>

                <!-- 3. Sea of Flowers -->
                <div class="theme-card" onclick="setTheme('sea_flower')" id="card-sea_flower">
                    <div class="theme-preview-box preview-sea_flower"></div>
                    <div class="theme-name">海底花海</div>
                    <div class="theme-desc">粉色渐变色<br>适用于清新手帐制作</div>
                </div>

                <!-- 4. Midnight -->
                <div class="theme-card" onclick="setTheme('midnight')" id="card-midnight">
                    <div class="theme-preview-box preview-midnight"></div>
                    <div class="theme-name">午夜星尘</div>
                    <div class="theme-desc">静谧深夜，独处时光</div>
                </div>
            </div>
        </div>
    </div>

    <div class="main-container">

        {% if show_list %}
        <div class="list-view">
            {% if diary_list|length == 0 %}
            <div class="empty-state">
                <div class="empty-icon">🕸️</div>
                <div class="empty-text">
                    {% if search_query %}
                    没有找到关于“{{ search_query }}”的回忆呢...
                    {% else %}
                    这里似乎落了一层灰，等待你来翻阅
                    {% endif %}
                </div>
                {% if not search_query %}
                <a href="/?view=edit&new=true"
                    style="margin-top: 30px; color: var(--accent-red); border-bottom: 1px dashed var(--accent-red); font-size: 14px;">
                    去擦拭灰尘 (写一篇) &rarr;
                </a>
                {% endif %}
            </div>
            {% else %}
            <div class="waterfall">
                {% for diary in diary_list %}
                <a href="/?view=read&file={{ diary.filename }}" class="card">
                    <div class="card-meta">
                        <span>{{ diary.date }}</span>
                        <div style="display: flex; gap: 8px;">
                            <span class="js-render-icon" data-type="weather" data-value="{{ diary.weather }}"></span>
                            <span class="js-render-icon" data-type="mood" data-value="{{ diary.mood }}"></span>
                        </div>
                    </div>
                    <div class="card-title">{{ diary.title }}</div>
                    <div class="card-preview">{{ diary.preview }}</div>
                </a>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        {% if show_read %}
        <div class="full-page-view">
            <div class="editor-top-bar">
                <a href="/" class="back-link">← 返回列表</a>
                <div class="action-btn-group">
                    <button type="button" class="icon-btn" onclick="exportToImage()" title="导出图片">📷 导出</button>
                    <a href="/?view=edit&file={{ data.filename }}" class="icon-btn" title="编辑">✎ 编辑</a>
                    <a href="/delete?file={{ data.filename }}" class="icon-btn delete"
                        onclick="return confirm('确认撕毁这张便签吗？');" title="删除">🗑️ 删除</a>
                </div>
            </div>

            <div class="paper-container">
                <div class="paper-sheet">
                    <div class="ribbon">
                        <div class="ribbon-stitch"></div>
                    </div>
                    <div class="read-header">
                        <h1 class="read-title">{{ data.title }}</h1>
                        <div class="read-meta">
                            <span>{{ data.date }}</span>
                            <span class="meta-separator">·</span>
                            <span class="js-render-icon" data-type="weather" data-value="{{ data.weather }}"></span>
                            <span>{{ data.weather_zh }}</span>
                            <span class="meta-separator">·</span>
                            <span class="js-render-icon" data-type="mood" data-value="{{ data.mood }}"></span>
                            <span>{{ data.mood_zh }}</span>
                        </div>
                        <div class="decorative-line"></div>
                    </div>
                    <div class="read-body">{{ data.content }}</div>
                    <div class="read-footer">
                        <div class="created-with">CREATED WITH<br><span>纸语 PaperWhisper</span></div>
                        <div style="opacity: 0.5;">🔗</div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if show_edit %}
        <div class="full-page-view">
            <form id="diary-form" method="POST" action="/" style="display: flex; flex-direction: column; height: 100%;">
                <input type="hidden" name="filename" value="{{ data.filename }}">
                <input type="hidden" name="is_markdown" id="is_markdown_input" value="{{ data.is_markdown }}">
                <div class="editor-top-bar">
                    <a href="/" class="back-link">← 放弃</a>
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <!-- Preview Button (Hidden by default) -->
                        <button type="button" id="preview-btn" class="icon-btn" onclick="togglePreview()"
                            style="display: none; font-size: 15px;" title="预览渲染效果">
                            👁️ 预览
                        </button>
                        <button type="submit" class="btn-done" onclick="isDirty=false;">
                            <span style="color: #c0392b;">✓</span> 完成
                        </button>
                    </div>
                </div>

                <div class="paper-container">
                    <div class="paper-sheet">
                        <div class="ribbon">
                            <div class="ribbon-stitch"></div>
                        </div>
                        <div class="edit-header">
                            <input type="text" name="title" class="edit-title" value="{{ data.title }}"
                                placeholder="在此输入标题..." autocomplete="off">
                            <div class="meta-row">
                                <div class="meta-item">
                                    <span class="meta-label">DATE</span>
                                    <input type="text" name="date" class="date-input-clean" value="{{ data.date }}">
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">WEATHER</span>
                                    <div style="display: flex; align-items: center;">
                                        <span id="weather-icon-container" class="edit-icon-wrapper"
                                            style="margin-right: 8px; display: flex;"></span>
                                        <select id="weather-select" name="weather" class="select-clean"
                                            onchange="updateIcon('weather')">
                                            <option value="sunny" {% if data.weather=='sunny' %}selected{% endif %}>晴
                                            </option>
                                            <option value="cloudy" {% if data.weather=='cloudy' %}selected{% endif %}>多云
                                            </option>
                                            <option value="rainy" {% if data.weather=='rainy' %}selected{% endif %}>雨
                                            </option>
                                            <option value="snowy" {% if data.weather=='snowy' %}selected{% endif %}>雪
                                            </option>
                                            <option value="windy" {% if data.weather=='windy' %}selected{% endif %}>风
                                            </option>
                                        </select>
                                    </div>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">MOOD</span>
                                    <div style="display: flex; align-items: center;">
                                        <span id="mood-icon-container" class="edit-icon-wrapper"
                                            style="margin-right: 8px; display: flex;"></span>
                                        <select id="mood-select" name="mood" class="select-clean"
                                            onchange="updateIcon('mood')">
                                            <option value="calm" {% if data.mood=='calm' %}selected{% endif %}>平静
                                            </option>
                                            <option value="happy" {% if data.mood=='happy' %}selected{% endif %}>开心
                                            </option>
                                            <option value="excited" {% if data.mood=='excited' %}selected{% endif %}>激动
                                            </option>
                                            <option value="sad" {% if data.mood=='sad' %}selected{% endif %}>忧郁</option>
                                            <option value="tired" {% if data.mood=='tired' %}selected{% endif %}>疲惫
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="divider-line"></div>

                        <!-- Markdown Toolbar -->
                        <div
                            style="display: flex; justify-content: flex-end; align-items: center; margin-bottom: 15px; gap: 15px;">
                            <div title="启用/关闭 Markdown 模式" id="markdown-toggle-btn" onclick="toggleMarkdownMode()"
                                style="cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 14px; color: var(--text-secondary); transition: all 0.3s; user-select: none;">
                                <span style="font-family: monospace; font-weight: bold; font-size: 16px;">M↓</span>
                                <span id="markdown-status-text">Markdown</span>
                            </div>
                        </div>

                        <!-- Hidden input for form submission -->
                        <input type="checkbox" id="markdown-toggle" style="display: none;" {% if
                            data.is_markdown=='true' %}checked{% endif %}>

                        <textarea id="diaryArea" class="edit-content" name="content" placeholder="从这里开始记录..."
                            oninput="autoResize(this)">{{ data.content }}</textarea>

                        <!-- Removed dotted border -->
                        <div id="previewArea" class="read-body" style="display: none; min-height: 500px;"></div>

                        <div class="read-footer">
                            <div class="created-with">CREATED WITH<br><span>纸语 PaperWhisper</span></div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}

    </div>

    <script>
        const iconPaths = {
            weather: {
                sunny: '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>',
                cloudy: '<path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"></path>',
                rainy: '<line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><line x1="10" y1="9" x2="9.6" y2="9.6"></line><path d="M20 16.58A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 4 15.25"></path>',
                snowy: '<line x1="8" y1="8" x2="16" y2="16"></line><line x1="16" y1="8" x2="8" y2="16"></line><line x1="12" y1="3" x2="12" y2="21"></line><line x1="3" y1="12" x2="21" y2="12"></line>',
                windy: '<path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path>'
            },
            mood: {
                calm: '<circle cx="12" cy="12" r="10"></circle><line x1="8" y1="15" x2="16" y2="15"></line><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>',
                happy: '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>',
                excited: '<circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line><line x1="12" y1="2" x2="12" y2="4"></line><line x1="4.93" y1="4.93" x2="6.34" y2="6.34"></line><line x1="19.07" y1="4.93" x2="17.66" y2="6.34"></line>',
                sad: '<circle cx="12" cy="12" r="10"></circle><path d="M16 16s-1.5-2-4-2-4 2-4 2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line>',
                tired: '<circle cx="12" cy="12" r="10"></circle><path d="M9 12h6"></path><path d="M15 9h.01"></path><path d="M9 9h.01"></path>'
            }
        };

        function getIconHtml(type, value) {
            const path = iconPaths[type][value] || iconPaths[type]['sunny'];
            return `<svg class="sys-icon" viewBox="0 0 24 24">${path}</svg>`;
        }

        function updateIcon(type) {
            const select = document.getElementById(type + '-select');
            const iconContainer = document.getElementById(type + '-icon-container');
            if (select && iconContainer) {
                iconContainer.innerHTML = getIconHtml(type, select.value);
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        window.onload = function () {
            var textarea = document.getElementById("diaryArea");
            if (textarea) {
                autoResize(textarea);
                // Don't focus immediately to avoid jumping if previewing
                if (document.getElementById('markdown-toggle') && document.getElementById('markdown-toggle').checked) {
                    updateMarkdownUI(); // Initialize UI state
                }

                updateIcon('weather');
                updateIcon('mood');
                flatpickr(".date-input-clean", { locale: "zh", dateFormat: "Y-m-d", altInput: true, altFormat: "Y/m/d", allowInput: false, static: true });
            }

            // Render Markdown in Read Mode if enabled
            const readBody = document.querySelector('.read-body');
            // Use rendered values strictly as strings or booleans
            const isReadMode = "{{ show_read }}" === "True";
            const isMarkdown = "{{ data.is_markdown }}".trim().toLowerCase() === "true";

            if (isReadMode && isMarkdown && readBody) {
                try {
                    if (typeof marked !== 'undefined') {
                        // Support both new (marked.parse) and old (marked) versions
                        const renderer = marked.parse || marked;
                        readBody.innerHTML = renderer(readBody.innerText);
                        readBody.style.whiteSpace = 'normal';
                    } else {
                        console.error('Marked.js missing');
                        alert('Markdown 渲染组件加载失败，请刷新重试');
                    }
                } catch (e) {
                    console.error('Markdown render error:', e);
                }
            }

            const iconPlaceholders = document.querySelectorAll('.js-render-icon');
            iconPlaceholders.forEach(el => {
                const type = el.getAttribute('data-type');
                const value = el.getAttribute('data-value');
                el.innerHTML = getIconHtml(type, value);
            });
        }

        function updateMarkdownUI() {
            const isChecked = document.getElementById('markdown-toggle').checked;
            const btn = document.getElementById('markdown-toggle-btn');
            const statusText = document.getElementById('markdown-status-text');

            // 1. Update Hidden Input
            document.getElementById('is_markdown_input').value = isChecked ? 'true' : 'false';

            // 2. Update UI Button Style
            if (isChecked) {
                btn.style.color = 'var(--accent-red)';
                btn.style.fontWeight = 'bold';
                statusText.innerText = 'Markdown';
            } else {
                btn.style.color = 'var(--text-secondary)';
                btn.style.fontWeight = 'normal';
                statusText.innerText = 'Markdown';
            }

            // 3. Toggle Preview Button Visibility
            document.getElementById('preview-btn').style.display = isChecked ? 'flex' : 'none';

            // 4. Reset View if Disabled
            if (!isChecked) {
                document.getElementById('diaryArea').style.display = 'block';
                document.getElementById('previewArea').style.display = 'none';
                document.getElementById('preview-btn').innerText = '👁️ 预览';
            }
        }

        function toggleMarkdownMode() {
            const checkbox = document.getElementById('markdown-toggle');
            checkbox.checked = !checkbox.checked; // Toggle State
            updateMarkdownUI(); // Update UI
        }

        function togglePreview() {
            const textarea = document.getElementById('diaryArea');
            const preview = document.getElementById('previewArea');
            const btn = document.getElementById('preview-btn');

            if (textarea.style.display !== 'none') {
                // Switch to Preview
                textarea.style.display = 'none';
                preview.style.display = 'block';
                preview.innerHTML = marked.parse(textarea.value);
                preview.style.whiteSpace = 'normal'; // Fix layout for MD
                // Keep lines in preview
                // preview.style.backgroundImage = 'none';
                btn.innerText = '✏️ 编辑';
            } else {
                // Switch to Edit
                textarea.style.display = 'block';
                preview.style.display = 'none';
                btn.innerText = '👁️ 预览';
                autoResize(textarea);
            }
        }

        // --- New Features Logic ---

        // 1. Safety: Unsaved Changes
        let isDirty = false;
        const diaryArea = document.getElementById('diaryArea');
        if (diaryArea) {
            diaryArea.addEventListener('input', () => { isDirty = true; });
        }

        // Intercept links
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', function (e) {
                if (isDirty && !confirm('您有未保存的修改，确定要离开吗？')) {
                    e.preventDefault();
                }
            });
        });
        // Before unload
        window.onbeforeunload = function () {
            if (isDirty) return "您有未保存的修改，确定要离开吗？";
        };

        // 2. Hitokoto
        fetch('https://v1.hitokoto.cn')
            .then(response => response.json())
            .then(data => {
                const hitokoto = document.getElementById('hitokoto-text');
                const author = document.getElementById('hitokoto-author');
                if (hitokoto && author) {
                    hitokoto.innerText = data.hitokoto;
                    author.innerText = `—— ${data.from}`;
                }
            })
            .catch(console.error);

        // 3. Export Image
        function exportToImage() {
            if (typeof html2canvas === 'undefined') {
                alert('错误：导出组件未加载 (html2canvas is undefined)');
                return;
            }

            const paper = document.querySelector('.paper-sheet');
            if (!paper) {
                alert('错误：找不到信纸元素');
                return;
            }

            // Temporary style adjustments for better screenshot
            const ribbon = paper.querySelector('.ribbon');
            if (ribbon) ribbon.style.display = 'none';

            // Show loading state
            const btn = document.querySelector('.icon-btn[title="导出图片"]');
            const originalText = btn ? btn.innerText : '📷 导出';
            if (btn) btn.innerText = '📷 正在生成...';

            html2canvas(paper, {
                backgroundColor: null, // Transparent bg if possible
                scale: 2, // High Resolution
                useCORS: true, // Try to handle cross-origin images
                logging: true // Enable logging for debug
            }).then(canvas => {
                if (ribbon) ribbon.style.display = 'block';
                if (btn) btn.innerText = originalText;

                // Send to backend
                const imageData = canvas.toDataURL("image/png");
                fetch('/save_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ image: imageData })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            prompt('✅ 导出成功！文件已保存至：\n(按 Ctrl+C 复制路径)', data.path);
                        } else {
                            alert('❌ 保存失败: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('❌ 请求失败: ' + error);
                    });

            }).catch(err => {
                if (ribbon) ribbon.style.display = 'block';
                if (btn) btn.innerText = originalText;
                alert('导出失败: ' + err);
                console.error(err);
            });
        }

        // 4. Settings & Theme Logic
        function openSettings() {
            const modal = document.getElementById('settings-modal');
            modal.style.display = 'flex';

            // Highlight current theme
            const currentTheme = localStorage.getItem('theme') || 'default';
            updateActiveCard(currentTheme);
        }

        function closeSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function updateActiveCard(themeName) {
            // Remove active class from all
            document.querySelectorAll('.theme-card').forEach(c => c.classList.remove('active'));
            // Add to current
            const card = document.getElementById('card-' + themeName);
            if (card) card.classList.add('active');
        }

        function setTheme(themeName) {
            // 1. Immediate UI Update
            document.body.setAttribute('data-theme', themeName);
            localStorage.setItem('theme', themeName); // Backup
            updateActiveCard(themeName);

            // 2. Server Sync
            fetch('/api/setting', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ theme: themeName })
            }).catch(err => console.error('Failed to sync theme:', err));

            // 3. 花瓣雨管理 (仅在海底花海主题下激活)
            if (themeName === 'sea_flower') {
                initPetalRain();
            } else {
                clearPetalRain();
            }
        }

        // 花瓣雨初始化函数
        function initPetalRain() {
            const container = document.getElementById('petal-rain');
            if (!container) return;

            // 清空现有花瓣
            container.innerHTML = '';

            // 生成40个花瓣 (增加数量以覆盖整个屏幕包括侧边栏)
            const petalCount = 40;

            // 粉紫色系颜色数组 (适配新主题)
            const colors = [
                '#F8BBD0',  // 淡粉色
                '#F48FB1',  // 粉色
                '#E1BEE7',  // 淡紫色
                '#CE93D8',  // 紫粉色
                '#FFE5F1',  // 极浅粉
                '#F3E5F5'   // 极浅紫
            ];

            for (let i = 0; i < petalCount; i++) {
                const petal = document.createElement('div');
                petal.className = 'petal';

                // 随机参数
                const size = 12 + Math.random() * 28; // 12px-40px (更大范围)
                const xPos = Math.random() * 100; // 0-100vw (覆盖整个宽度包括侧边栏)
                const duration = 12 + Math.random() * 18; // 12s-30s (加快一些)
                const delay = -Math.random() * 20; // 负延迟使初始就有花瓣分布在屏幕各处

                // 随机颜色
                const color = colors[Math.floor(Math.random() * colors.length)];

                // 景深效果:大花瓣 = 近景 (清晰+不透明), 小花瓣 = 远景 (模糊+半透明)
                const blur = size < 20 ? 2 + Math.random() * 4 : 0; // 小花瓣模糊2-6px
                const opacity = size < 20 ? 0.4 + Math.random() * 0.3 : 0.7 + Math.random() * 0.25; // 小花瓣0.4-0.7, 大花瓣0.7-0.95

                // 设置CSS变量
                petal.style.setProperty('--petal-size', `${size}px`);
                petal.style.setProperty('--petal-duration', `${duration}s`);
                petal.style.setProperty('--petal-delay', `${delay}s`);
                petal.style.setProperty('--petal-blur', `${blur}px`);
                petal.style.setProperty('--petal-opacity', opacity);
                petal.style.setProperty('--petal-color', color);
                petal.style.left = `${xPos}%`;

                container.appendChild(petal);
            }
        }

        // 清除花瓣雨
        function clearPetalRain() {
            const container = document.getElementById('petal-rain');
            if (container) {
                container.innerHTML = '';
            }
        }

        // 页面加载时初始化花瓣雨 (如果当前主题是海底花海)
        document.addEventListener('DOMContentLoaded', function () {
            const currentTheme = document.body.getAttribute('data-theme');
            if (currentTheme === 'sea_flower') {
                initPetalRain();
            }
        });

        // Initialize Theme IIFE moved to top of body to prevent FOUC

    </script>

    <!-- Update Announcement Modal (Skeuomorphic) -->
    <div id="update-modal" class="modal-overlay" style="display: none;">
        <div class="update-card">
            <div class="wax-seal">
                <span>NEW</span>
            </div>
            <div class="card-header">
                <h2>版本 {{ current_version }} 更新</h2>
                <div class="divider"></div>
            </div>
            <div class="card-content">
                <ul class="feature-list">
                    <li>
                        <span class="icon">🎨</span>
                        <div class="details">
                            <strong>全新三大主题</strong>
                            <p>海底花海、时光旧物、午夜星尘 - 沉浸式写作体验</p>
                        </div>
                    </li>
                    <li>
                        <span class="icon">📝</span>
                        <div class="details">
                            <strong>Markdown 完美适配</strong>
                            <p>实时预览，更好的排版与存储支持</p>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="card-footer">
                <button class="btn-confirm" onclick="closeUpdateModal()">知道了</button>
            </div>
        </div>
    </div>

    <script>
        // Check if modal should show (injected by Flask)
        const shouldShowUpdate = "{{ 'true' if show_update_modal else 'false' }}" === "true";
        const currentVersion = "{{ current_version }}";

        if (shouldShowUpdate) {
            document.getElementById('update-modal').style.display = 'flex';
        }

        function closeUpdateModal() {
            const modal = document.getElementById('update-modal');
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);

            // Save state to backend
            fetch('/api/setting', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ last_seen_version: currentVersion })
            });
        }
    </script>
</body>

</html>